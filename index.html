<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oakberry Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom right, #f8f7ff, #f3f1ff);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* === SIDEBAR === */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #6B21A8 0%, #581C87 100%);
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        }
        
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Bot√≥n X para cerrar (solo m√≥vil) */
        .sidebar-close {
            display: none;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sidebar-close:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Overlay para m√≥vil */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
        
        .sidebar-logo {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 1px;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 500;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: #FCD34D;
        }
        
        .menu-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: #FCD34D;
            font-weight: 600;
        }
        
        .menu-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }
        
        /* === MAIN CONTENT === */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        /* === HEADER === */
        .dashboard-header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .toggle-sidebar {
            display: none;
            padding: 8px 12px;
            background: #6B21A8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }
        
        /* === LOADER === */
        .oakberry-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #581C87 0%, #6B21A8 50%, #7C3AED 100%);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .oakberry-loader.active {
            display: flex;
        }
        
        .oakberry-text {
            font-size: 72px;
            font-weight: 900;
            letter-spacing: 8px;
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
            gap: 4px;
        }
        
        .oakberry-text span {
            color: white;
            opacity: 0;
            transform: translateY(30px) scale(0.5);
            animation: letterAppear 0.6s ease-out forwards;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5), 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .oakberry-text span:nth-child(1) { animation-delay: 0.1s; }
        .oakberry-text span:nth-child(2) { animation-delay: 0.2s; }
        .oakberry-text span:nth-child(3) { animation-delay: 0.3s; }
        .oakberry-text span:nth-child(4) { animation-delay: 0.4s; }
        .oakberry-text span:nth-child(5) { animation-delay: 0.5s; }
        .oakberry-text span:nth-child(6) { animation-delay: 0.6s; }
        .oakberry-text span:nth-child(7) { animation-delay: 0.7s; }
        .oakberry-text span:nth-child(8) { animation-delay: 0.8s; }
        
        @keyframes letterAppear {
            0% { opacity: 0; transform: translateY(30px) scale(0.5) rotateX(-90deg); }
            50% { opacity: 0.5; transform: translateY(-10px) scale(1.1) rotateX(10deg); }
            100% { opacity: 1; transform: translateY(0) scale(1) rotateX(0deg); }
        }
        
        .progress-bar-container {
            width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            margin: 0 auto 20px;
        }
        
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #FCD34D 0%, #FBBF24 25%, #F59E0B 50%, #FBBF24 75%, #FCD34D 100%);
            background-size: 200% 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6);
            animation: shimmerProgress 2s linear infinite;
        }
        
        @keyframes shimmerProgress {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loading-percentage {
            color: #FCD34D;
            font-size: 42px;
            font-weight: 900;
            text-shadow: 0 0 30px rgba(252, 211, 77, 0.8);
            margin-bottom: 15px;
            letter-spacing: 3px;
        }
        
        /* === SECCIONES === */
        .section {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* === CARDS === */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #6B21A8, #7C3AED);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(107, 33, 168, 0.3);
        }
        
        /* === DATE INPUT === */
        .date-input {
            padding: 10px 15px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: border-color 0.2s;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #6B21A8;
        }
        
        .btn-apply {
            padding: 10px 24px;
            background: linear-gradient(135deg, #6B21A8, #7C3AED);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 33, 168, 0.3);
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-close {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toggle-sidebar {
                display: block;
            }
            
            .oakberry-text {
                font-size: 48px;
                letter-spacing: 4px;
            }
            
            .loading-percentage {
                font-size: 32px;
            }
            
            .progress-bar-container {
                width: 300px;
            }
        }
        
        /* Badge */
        .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #EF4444;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* === REPORTE DIARIO === */
        #tablaReporteDiario {
            min-width: 800px;
        }

        #tablaReporteDiario th {
            font-size: 12px;
            white-space: nowrap;
            border-right: 1px solid #E5E7EB;
        }

        #tablaReporteDiario td {
            padding: 10px 12px;
            text-align: right;
            border-right: 1px solid #E5E7EB;
            border-bottom: 1px solid #F3F4F6;
        }

        #tablaReporteDiario td:first-child {
            text-align: left;
            font-weight: 600;
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
        }

        #tablaReporteDiario tbody tr:hover {
            background: #F9FAFB;
        }

        #tablaReporteDiario tbody tr:last-child {
            background: #EDE9FE;
            font-weight: 700;
        }

        #tablaReporteDiario tbody tr:last-child td:first-child {
            background: #EDE9FE;
        }
    </style>
</head>
<body>
    <!-- LOADER -->
    <div class="oakberry-loader" id="oakberryLoader">
        <div style="text-align: center;">
            <div class="oakberry-text">
                <span>O</span><span>A</span><span>K</span><span>B</span><span>E</span><span>R</span><span>R</span><span>Y</span>
            </div>
            <div class="loading-percentage" id="loadingPercentage">0%</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
        </div>
    </div>

    <!-- OVERLAY PARA M√ìVIL -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div>
                <div class="sidebar-logo">ü´ê OAKBERRY</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Dashboard Analytics</div>
            </div>
            <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="showSection('dashboard')">
                <span class="menu-item-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" onclick="showSection('reporteDiario')">
                <span class="menu-item-icon">üìÖ</span>
                <span>Reporte Diario</span>
            </div>
            <div class="menu-item" onclick="showSection('analisis')">
                <span class="menu-item-icon">üìà</span>
                <span>An√°lisis</span>
            </div>
            <div class="menu-item" onclick="showSection('descuentos')">
                <span class="menu-item-icon">üí∞</span>
                <span>Descuentos</span>
            </div>
            <div class="menu-item" onclick="showSection('ventasMes')">
                <span class="menu-item-icon">üìÜ</span>
                <span>Ventas por Mes</span>
            </div>
            <div class="menu-item" onclick="showSection('ventasSemana')">
                <span class="menu-item-icon">üìä</span>
                <span>Ventas por Semana</span>
            </div>
            <div class="menu-item" onclick="showSection('ticketMedio')">
                <span class="menu-item-icon">üé´</span>
                <span>Ticket Medio</span>
            </div>
            <div class="menu-item" onclick="showSection('detallePagos')">
                <span class="menu-item-icon">üí≥</span>
                <span>Detalle de Pagos</span>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="mainContent">
        <!-- HEADER -->
        <div class="dashboard-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞</button>
                    <div>
                        <h1 style="font-size: 24px; font-weight: 800; color: #6B21A8;">Dashboard Oakberry</h1>
                        <p style="font-size: 13px; color: #6B7280;">√öltima actualizaci√≥n: <span id="ultimaActualizacion">--:--</span></p>
                    </div>
                </div>
                
                <!-- DATE RANGE PICKER & STORE SELECTOR -->
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 12px; color: #6B7280; font-weight: 600;">Desde:</label>
                        <input type="date" class="date-input" id="fechaInicio" style="min-width: 150px;">
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 12px; color: #6B7280; font-weight: 600;">Hasta:</label>
                        <input type="date" class="date-input" id="fechaFin" style="min-width: 150px;">
                    </div>
                    
                    <!-- Selector de Tiendas -->
                    <div style="position: relative;">
                        <button class="date-input" onclick="toggleTiendasDropdown(event)" style="cursor: pointer; min-width: 180px; display: flex; justify-content: space-between; align-items: center;">
                            <span id="tiendasLabel">üìä Todas las tiendas</span>
                            <span style="margin-left: 8px;">‚ñº</span>
                        </button>
                        
                        <div id="tiendasDropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: white; border: 2px solid #E5E7EB; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); min-width: 250px; z-index: 1000; max-height: 400px; overflow-y: auto;">
                            <div style="padding: 12px;">
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="tienda-checkbox" value="todas" data-nombre="Todas" checked onchange="handleTiendaChange(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; font-size: 14px;">üìä Todas las tiendas</span>
                                </label>
                                
                                <div style="border-top: 2px solid #E5E7EB; margin: 8px 0;"></div>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="tienda-checkbox tienda-individual" value="guachipelin" data-nombre="Guachipel√≠n" onchange="handleTiendaChange(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px;">üè™ Guachipel√≠n</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="tienda-checkbox tienda-individual" value="escazu" data-nombre="Avenida Escaz√∫" onchange="handleTiendaChange(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px;">üè™ Avenida Escaz√∫</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="tienda-checkbox tienda-individual" value="citymall" data-nombre="City Mall" onchange="handleTiendaChange(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px;">üè™ City Mall</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="tienda-checkbox tienda-individual" value="aleste" data-nombre="Tuk Tuk" onchange="handleTiendaChange(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px;">üè™ Tuk Tuk</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="tienda-checkbox tienda-individual" value="santaana" data-nombre="Santa Ana TC" onchange="handleTiendaChange(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px;">üè™ Santa Ana TC</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-apply" onclick="cargarDatos()" id="btnActualizar">üîÑ Actualizar</button>
                </div>
            </div>
        </div>

        <!-- SECTION: DASHBOARD -->
        <div class="section active" id="section-dashboard">
            <div style="padding: 0 10px;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #111827;">Vista General</h2>
                
                <!-- KPIs Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px;">
                    <div class="kpi-card">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Ventas del D√≠a</div>
                        <div style="font-size: 28px; font-weight: 900;" id="kpiVentasDia">‚Ç°0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Forecast: <span id="kpiForecast">‚Ç°0</span></div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #10B981, #059669);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Crecimiento D√≠a</div>
                        <div style="font-size: 28px; font-weight: 900;" id="kpiCrecimiento">+0%</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">vs <span id="fechaRef">--/--</span></div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Ventas Acumuladas</div>
                        <div style="font-size: 28px; font-weight: 900;" id="kpiVentasAcum">‚Ç°0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Crec: <span id="kpiCrecAcum">+0%</span></div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Transacciones</div>
                        <div style="font-size: 28px; font-weight: 900;" id="kpiTransacciones">0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Acum: <span id="kpiTransAcum">0</span></div>
                    </div>
                </div>

                <!-- Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="card">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Canales de Venta</h3>
                        <canvas id="chartCanales" style="max-height: 250px;"></canvas>
                    </div>
                    <div class="card">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">M√©todos de Pago</h3>
                        <canvas id="chartPagos" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <!-- Table -->
                <div class="card">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Detalle por Tienda</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #F3F4F6;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; border-right: 2px solid #E5E7EB;">Tienda</th>
                                    <th colspan="4" style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600; background: #EDE9FE; border-right: 2px solid #E5E7EB;">üìä D√≠a</th>
                                    <th colspan="4" style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600; background: #DBEAFE;">üìà Acumulado</th>
                                </tr>
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; border-right: 2px solid #E5E7EB;"></th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #F3E8FF;">Ventas</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #F3E8FF;">Forecast</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #F3E8FF;">Desv %</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #F3E8FF; border-right: 2px solid #E5E7EB;">Crec %</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #DBEAFE;">V. Acum</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #DBEAFE;">Fcst Acum</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #DBEAFE;">Desv %</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; background: #DBEAFE;">Crec %</th>
                                </tr>
                            </thead>
                            <tbody id="tablaTiendas">
                                <tr><td colspan="9" style="padding: 40px; text-align: center; color: #9CA3AF;">Cargando datos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: REPORTE DIARIO -->
        <div class="section" id="section-reporteDiario">
            <div style="padding: 0 10px;">
                <!-- Header con tabs y bot√≥n de exportar -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2 style="font-size: 20px; font-weight: 700; color: #111827; margin-bottom: 8px;">Reporte Diario</h2>
                        <p style="font-size: 13px; color: #6B7280;">Ventas por d√≠a seg√∫n rango seleccionado</p>
                    </div>
                    
                    <!-- Bot√≥n Exportar Excel -->
                    <button onclick="exportarReporteDiarioExcel()" style="padding: 10px 20px; background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        üìä Exportar XLS
                    </button>
                </div>
                
                <!-- Contenedor de la tabla -->
                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;" id="tituloReporteDiario">Venta Sin Impuestos</h3>
                    
                    <div style="overflow-x: auto;">
                        <table id="tablaReporteDiario" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr id="headerReporteDiario" style="background: #F3F4F6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; position: sticky; left: 0; background: #F3F4F6; z-index: 10; border-right: 2px solid #D1D5DB;">Local</th>
                                    <!-- Las columnas de fechas se generar√°n din√°micamente -->
                                </tr>
                            </thead>
                            <tbody id="bodyReporteDiario">
                                <tr>
                                    <td colspan="100" style="padding: 40px; text-align: center; color: #9CA3AF;">
                                        Selecciona un rango de fechas y presiona Actualizar
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: DESCUENTOS -->
        <div class="section" id="section-descuentos">
            <div style="padding: 0 10px;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">Gesti√≥n de Descuentos</h2>
                
                <!-- KPIs Descuentos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: #FEF3C7; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 13px; color: #92400E; margin-bottom: 8px;">Descuentos del D√≠a</div>
                        <div style="font-size: 28px; font-weight: 900; color: #92400E;" id="descDia">‚Ç°0</div>
                    </div>
                    <div style="background: #FEF3C7; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 13px; color: #92400E; margin-bottom: 8px;">Descuentos Acumulados</div>
                        <div style="font-size: 28px; font-weight: 900; color: #92400E;" id="descAcum">‚Ç°0</div>
                    </div>
                    <div style="background: #FEE2E2; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 13px; color: #991B1B; margin-bottom: 8px;">Anulaciones D√≠a</div>
                        <div style="font-size: 28px; font-weight: 900; color: #991B1B;" id="anulDia">0</div>
                    </div>
                    <div style="background: #FEE2E2; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 13px; color: #991B1B; margin-bottom: 8px;">Anulaciones Acum.</div>
                        <div style="font-size: 28px; font-weight: 900; color: #991B1B;" id="anulAcum">0</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">√ìrdenes con Descuentos ‚â•50%</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #F3F4F6;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 13px;">Tienda</th>
                                    <th style="padding: 12px; text-align: center; font-size: 13px;">Fecha</th>
                                    <th style="padding: 12px; text-align: center; font-size: 13px;"># Orden</th>
                                    <th style="padding: 12px; text-align: center; font-size: 13px;">Descuento</th>
                                    <th style="padding: 12px; text-align: center; font-size: 13px;">%</th>
                                </tr>
                            </thead>
                            <tbody id="tablaDescuentos">
                                <tr><td colspan="5" style="padding: 40px; text-align: center; color: #9CA3AF;">Sin datos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: AN√ÅLISIS -->
        <div class="section" id="section-analisis">
            <div style="padding: 0 10px;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">An√°lisis Detallado</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Descuentos por Canal</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">üü¢ Uber Eats</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descUber">‚Ç°0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">üî¥ Pedidos Ya</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descPeya">‚Ç°0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">üü† Didi Food</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descDidi">‚Ç°0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">‚ö´ Otros</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descOtrosCanal">‚Ç°0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Descuentos por Pago</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">üí≥ Tarjeta</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descTarjeta">‚Ç°0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">üíµ Efectivo</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descEfectivo">‚Ç°0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">üì± Sinpe</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descSinpe">‚Ç°0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                                <span style="font-size: 14px; color: #6B7280;">üí∞ Otros</span>
                                <span style="font-size: 14px; font-weight: 600;" id="descOtrosPago">‚Ç°0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: VENTAS POR MES -->
        <div class="section" id="section-ventasMes">
            <div style="padding: 0 10px;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">Ventas por Mes</h2>
                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Comparativo Mensual</h3>
                    <div style="background: #FEF3C7; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="font-size: 14px; color: #92400E;">
                            <strong>üìä Pr√≥ximamente:</strong> Visualizaci√≥n de ventas mensuales comparativas por a√±o y por tienda.
                        </p>
                    </div>
                    <canvas id="chartVentasMes" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>

        <!-- SECTION: VENTAS POR SEMANA -->
        <div class="section" id="section-ventasSemana">
            <div style="padding: 0 10px;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">Ventas por Semana & Participaci√≥n</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Ventas Semanales</h3>
                        <div style="background: #DBEAFE; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                            <p style="font-size: 14px; color: #1E40AF;">
                                <strong>üìä Pr√≥ximamente:</strong> An√°lisis de ventas por semana del mes.
                            </p>
                        </div>
                        <canvas id="chartVentasSemana"></canvas>
                    </div>
                    <div class="card">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Participaci√≥n por Local</h3>
                        <canvas id="chartParticipacion"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: TICKET MEDIO -->
        <div class="section" id="section-ticketMedio">
            <div style="padding: 0 10px;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">Ticket Medio & √ìrdenes</h2>
                <div class="card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Ticket Promedio D√≠a</div>
                            <div style="font-size: 32px; font-weight: 900;" id="ticketPromedioDia">‚Ç°0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Ticket Promedio Acum.</div>
                            <div style="font-size: 32px; font-weight: 900;" id="ticketPromedioAcum">‚Ç°0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">√ìrdenes/D√≠a</div>
                            <div style="font-size: 32px; font-weight: 900;" id="ordenesDia">0</div>
                        </div>
                    </div>
                    <div style="background: #F3F4F6; padding: 16px; border-radius: 12px;">
                        <p style="font-size: 14px; color: #6B7280;">
                            <strong>üí° C√°lculo:</strong> Ticket Medio = Ventas Netas / N√∫mero de Transacciones
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: DETALLE PAGOS -->
        <div class="section" id="section-detallePagos">
            <div style="padding: 0 10px;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">Detalle de M√©todos de Pago</h2>
                
                <!-- KPIs M√©todos de Pago -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="kpi-card" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">üí≥ Tarjeta (D√≠a)</div>
                        <div style="font-size: 28px; font-weight: 900;" id="pagoTarjetaDia">‚Ç°0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Acum: <span id="pagoTarjetaAcum">‚Ç°0</span></div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #10B981, #059669);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">üíµ Efectivo (D√≠a)</div>
                        <div style="font-size: 28px; font-weight: 900;" id="pagoEfectivoDia">‚Ç°0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Acum: <span id="pagoEfectivoAcum">‚Ç°0</span></div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #3B82F6, #2563EB);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">üì± Sinpe (D√≠a)</div>
                        <div style="font-size: 28px; font-weight: 900;" id="pagoSinpeDia">‚Ç°0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Acum: <span id="pagoSinpeAcum">‚Ç°0</span></div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #6B7280, #4B5563);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">üí∞ Otros (D√≠a)</div>
                        <div style="font-size: 28px; font-weight: 900;" id="pagoOtrosDia">‚Ç°0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Acum: <span id="pagoOtrosAcum">‚Ç°0</span></div>
                    </div>
                </div>

                <!-- Gr√°fico de M√©todos de Pago -->
                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Distribuci√≥n de M√©todos de Pago</h3>
                    <canvas id="chartDetalleMetodosPago" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è IMPORTANTE: Reemplaza esta URL con tu Apps Script URL real
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz26uhBqgZLYt5uuCu-VY7P9SwbeNkQbhb3HClift2LBRXokU72JJhHRnlvoteHzaMk/exec';
        
        let progressInterval;
        let progressValue = 0;
        let datosGlobales = null;
        let charts = {};

        // üîß FUNCI√ìN AUXILIAR: Obtener valor num√©rico seguro
        function getNumericValue(value, defaultValue = 0) {
            if (value === null || value === undefined || value === '' || isNaN(value)) {
                return defaultValue;
            }
            const num = Number(value);
            return isNaN(num) ? defaultValue : num;
        }

        // üîß FUNCI√ìN AUXILIAR: Formatear porcentaje con signo
        function formatPercentage(value, decimals = 1) {
            const num = getNumericValue(value, 0);
            const sign = num > 0 ? '+' : '';
            return `${sign}${num.toFixed(decimals)}%`;
        }

        // üîß FUNCI√ìN AUXILIAR: Formatear moneda
        function formatCurrency(value) {
            const num = getNumericValue(value, 0);
            return `‚Ç°${Math.round(num).toLocaleString('es-CR')}`;
        }

        // === LOADER ===
        function mostrarProgreso() {
            const loader = document.getElementById('oakberryLoader');
            const progressBar = document.getElementById('progressBarFill');
            const percentage = document.getElementById('loadingPercentage');
            
            loader.classList.add('active');
            progressValue = 0;
            progressBar.style.width = '0%';
            percentage.textContent = '0%';
            
            progressInterval = setInterval(() => {
                const incremento = progressValue < 30 ? Math.random() * 15 : 
                                  progressValue < 60 ? Math.random() * 8 : 
                                  progressValue < 80 ? Math.random() * 4 : 
                                  Math.random() * 1.5;
                
                progressValue += incremento;
                if (progressValue > 85) progressValue = 85;
                
                progressBar.style.width = progressValue + '%';
                percentage.textContent = Math.round(progressValue) + '%';
            }, 100);
        }

        function completarProgreso() {
            if (progressInterval) clearInterval(progressInterval);
            
            const progressBar = document.getElementById('progressBarFill');
            const percentage = document.getElementById('loadingPercentage');
            const loader = document.getElementById('oakberryLoader');
            
            const targetInterval = setInterval(() => {
                progressValue += 8;
                
                if (progressValue >= 100) {
                    progressValue = 100;
                    progressBar.style.width = '100%';
                    percentage.textContent = '100%';
                    clearInterval(targetInterval);
                    
                    setTimeout(() => {
                        loader.classList.remove('active');
                        progressBar.style.width = '0%';
                        percentage.textContent = '0%';
                        progressValue = 0;
                    }, 400);
                } else {
                    progressBar.style.width = progressValue + '%';
                    percentage.textContent = Math.round(progressValue) + '%';
                }
            }, 30);
        }

        // === NAVIGATION ===
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            
            document.getElementById('section-' + sectionName).classList.add('active');
            event.target.closest('.menu-item').classList.add('active');
            
            // Cerrar sidebar en m√≥vil al seleccionar una opci√≥n
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // === TIENDAS SELECTOR ===
        function toggleTiendasDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('tiendasDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function handleTiendaChange(checkbox) {
            const todasCheckbox = document.querySelector('.tienda-checkbox[value="todas"]');
            const individualesCheckboxes = document.querySelectorAll('.tienda-individual');
            
            if (checkbox.value === 'todas') {
                if (checkbox.checked) {
                    // Si se marca "Todas", desmarcar las individuales
                    individualesCheckboxes.forEach(cb => cb.checked = false);
                }
            } else {
                // Si se marca una tienda individual, desmarcar "Todas"
                if (checkbox.checked && todasCheckbox) {
                    todasCheckbox.checked = false;
                }
                
                // Si no hay ninguna marcada, marcar "Todas"
                const algunaMarcada = Array.from(individualesCheckboxes).some(cb => cb.checked);
                if (!algunaMarcada && todasCheckbox) {
                    todasCheckbox.checked = true;
                }
            }
            
            actualizarLabelTiendas();
        }

        function actualizarLabelTiendas() {
            const checkboxes = document.querySelectorAll('.tienda-checkbox:checked');
            const label = document.getElementById('tiendasLabel');
            
            if (checkboxes.length === 0) {
                label.textContent = 'üìä Selecciona tiendas';
                return;
            }
            
            const todasCheckbox = document.querySelector('.tienda-checkbox[value="todas"]');
            if (todasCheckbox && todasCheckbox.checked) {
                label.textContent = 'üìä Todas las tiendas';
                return;
            }
            
            if (checkboxes.length === 1) {
                label.textContent = 'üè™ ' + checkboxes[0].dataset.nombre;
            } else {
                label.textContent = `üè™ ${checkboxes.length} tiendas`;
            }
        }

        function obtenerTiendasSeleccionadas() {
            const checkboxes = document.querySelectorAll('.tienda-checkbox:checked');
            const tiendas = Array.from(checkboxes).map(cb => cb.value);
            
            if (tiendas.includes('todas')) return 'todas';
            if (tiendas.length === 0) return 'todas';
            
            return tiendas.join(',');
        }

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('tiendasDropdown');
            const button = event.target.closest('button');
            
            if (dropdown && !dropdown.contains(event.target) && (!button || button.id !== 'tiendasButton')) {
                dropdown.style.display = 'none';
            }
        });

        // === DATA LOADING ===
async function cargarDatos() {
    const fechaInicioInput = document.getElementById('fechaInicio').value;
    const fechaFinInput = document.getElementById('fechaFin').value;
    
    if (!fechaInicioInput || !fechaFinInput) {
        alert('Por favor selecciona ambas fechas (inicio y fin)');
        return;
    }
    
    const fechaInicio = new Date(fechaInicioInput + 'T12:00:00');
    const fechaFin = new Date(fechaFinInput + 'T12:00:00');
    
    if (fechaInicio > fechaFin) {
        alert('La fecha inicial debe ser menor o igual a la fecha final');
        return;
    }
    
    const tiendasSeleccionadas = obtenerTiendasSeleccionadas();
    const seccionActiva = document.querySelector('.section.active');
    const esReporteDiario = seccionActiva && seccionActiva.id === 'section-reporteDiario';
    
    if (esReporteDiario) {
        await cargarReporteDiario();
    } else {
        const day = fechaFin.getDate();
        const month = fechaFin.getMonth() + 1;
        const year = fechaFin.getFullYear();
        
        const url = `${APPS_SCRIPT_URL}?day=${day}&month=${month}&year=${year}&tienda=${tiendasSeleccionadas}&modoRapido=true`;
        
        console.log('üì° Cargando dashboard desde:', url);
        
        // üî• MOSTRAR LOADING SIN RECARGAR P√ÅGINA
        mostrarLoadingDashboard();
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            console.log('üìä Datos recibidos:', data);
            
            if (!data || data.length === 0 || data.error) {
                ocultarLoadingDashboard();
                alert('Error al cargar datos: ' + (data.error || data.message || 'Sin datos'));
                return;
            }
            
            datosGlobales = data;
            actualizarDashboard(data); // Esta funci√≥n ya existe en tu c√≥digo
            ocultarLoadingDashboard();
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            ocultarLoadingDashboard();
            alert('Error de conexi√≥n: ' + error.message);
        }
    }
}
        // üî• AGREGAR estas dos funciones nuevas
function mostrarLoadingDashboard() {
    const btnActualizar = document.getElementById('btnActualizar');
    if (btnActualizar) {
        btnActualizar.disabled = true;
        btnActualizar.innerHTML = '‚è≥ Cargando...';
    }
    
    document.querySelectorAll('.kpi-card').forEach(card => {
        card.style.opacity = '0.3';
        card.style.pointerEvents = 'none';
    });
    
    const tablaTiendas = document.getElementById('tablaTiendas');
    if (tablaTiendas) {
        tablaTiendas.innerHTML = `
            <tr>
                <td colspan="9" style="padding: 60px 20px; text-align: center;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #E5E7EB; border-top-color: #6B21A8; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;"></div>
                    <div style="font-size: 18px; font-weight: 700; color: #6B21A8; margin-bottom: 5px;">Cargando informaci√≥n...</div>
                    <div style="font-size: 14px; color: #6B7280;">Por favor espera un momento</div>
                </td>
            </tr>
        `;
    }
    
    document.querySelectorAll('canvas').forEach(canvas => {
        const parent = canvas.parentElement;
        if (parent) {
            parent.style.opacity = '0.3';
            parent.style.pointerEvents = 'none';
        }
    });
}

function ocultarLoadingDashboard() {
    const btnActualizar = document.getElementById('btnActualizar');
    if (btnActualizar) {
        btnActualizar.disabled = false;
        btnActualizar.innerHTML = 'üîÑ Actualizar';
    }
    
    document.querySelectorAll('.kpi-card').forEach(card => {
        card.style.opacity = '1';
        card.style.pointerEvents = 'auto';
    });
    
    document.querySelectorAll('canvas').forEach(canvas => {
        const parent = canvas.parentElement;
        if (parent) {
            parent.style.opacity = '1';
            parent.style.pointerEvents = 'auto';
        }
    });
}
        function actualizarDashboard(data) {
            console.log('üîÑ Actualizando dashboard...');
            
            if (!data || data.length === 0) {
                console.error('No hay datos para actualizar');
                return;
            }
            
            // Obtener row consolidado (TODAS)
            const totalRow = data.find(r => r.tienda === 'TODAS') || data[0];
            
            if (!totalRow) {
                console.error('No se encontr√≥ totalRow');
                return;
            }
            
            console.log('üìã Total Row:', totalRow);
            
            // Actualizar KPIs principales
            document.getElementById('kpiVentasDia').textContent = formatCurrency(totalRow.ventasNetas);
            document.getElementById('kpiForecast').textContent = formatCurrency(totalRow.forecast);
            document.getElementById('kpiCrecimiento').textContent = formatPercentage(totalRow.crecimientoDia);
            document.getElementById('fechaRef').textContent = (totalRow.fechaRefDia || '--/--').split('/').slice(0,2).join('/');
            document.getElementById('kpiVentasAcum').textContent = formatCurrency(totalRow.ventasAcumuladas);
            document.getElementById('kpiCrecAcum').textContent = formatPercentage(totalRow.crecimientoAcum);
            document.getElementById('kpiTransacciones').textContent = getNumericValue(totalRow.transacciones, 0);
            document.getElementById('kpiTransAcum').textContent = getNumericValue(totalRow.transaccionesAcum, 0);
            
            // Actualizar descuentos
            document.getElementById('descDia').textContent = formatCurrency(totalRow.descuentosDia);
            document.getElementById('descAcum').textContent = formatCurrency(totalRow.descuentosAcum);
            document.getElementById('anulDia').textContent = getNumericValue(totalRow.anulacionesDia, 0);
            document.getElementById('anulAcum').textContent = getNumericValue(totalRow.anulacionesAcum, 0);
            
            // Actualizar an√°lisis
            document.getElementById('descUber').textContent = formatCurrency(totalRow.descUberDia);
            document.getElementById('descPeya').textContent = formatCurrency(totalRow.descPeyaDia);
            document.getElementById('descDidi').textContent = formatCurrency(totalRow.descDidiDia);
            document.getElementById('descOtrosCanal').textContent = formatCurrency(totalRow.descOtrosCanalDia);
            document.getElementById('descTarjeta').textContent = formatCurrency(totalRow.descTarjetaDia);
            document.getElementById('descEfectivo').textContent = formatCurrency(totalRow.descEfectivoDia);
            document.getElementById('descSinpe').textContent = formatCurrency(totalRow.descSinpeDia);
            document.getElementById('descOtrosPago').textContent = formatCurrency(totalRow.descOtrosPagoDia);
            
            // Actualizar Ticket Medio
            const ticketPromedioDia = totalRow.transacciones > 0 ? totalRow.ventasNetas / totalRow.transacciones : 0;
            const ticketPromedioAcum = totalRow.transaccionesAcum > 0 ? totalRow.ventasAcumuladas / totalRow.transaccionesAcum : 0;
            document.getElementById('ticketPromedioDia').textContent = formatCurrency(ticketPromedioDia);
            document.getElementById('ticketPromedioAcum').textContent = formatCurrency(ticketPromedioAcum);
            document.getElementById('ordenesDia').textContent = getNumericValue(totalRow.transacciones, 0);
            
            // Actualizar Detalle de Pagos
            document.getElementById('pagoTarjetaDia').textContent = formatCurrency(totalRow.tarjeta);
            document.getElementById('pagoTarjetaAcum').textContent = formatCurrency(totalRow.tarjetaAcum);
            document.getElementById('pagoEfectivoDia').textContent = formatCurrency(totalRow.efectivo);
            document.getElementById('pagoEfectivoAcum').textContent = formatCurrency(totalRow.efectivoAcum);
            document.getElementById('pagoSinpeDia').textContent = formatCurrency(totalRow.sinpeMovil);
            document.getElementById('pagoSinpeAcum').textContent = formatCurrency(totalRow.sinpeMovilAcum);
            document.getElementById('pagoOtrosDia').textContent = formatCurrency(totalRow.otrosPagos);
            document.getElementById('pagoOtrosAcum').textContent = formatCurrency(totalRow.otrosPagosAcum);
            
            // Actualizar timestamp
            document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString('es-ES');
            
            // Actualizar tabla de tiendas
            actualizarTablaTiendas(data);
            
            // Actualizar tabla de descuentos
            actualizarTablaDescuentos(totalRow);
            
            // Actualizar gr√°ficos
            actualizarGraficos(totalRow);
            
            // Actualizar Reporte Diario
            generarTablaReporteDiario(data);
        }

        function actualizarTablaTiendas(data) {
            const tbody = document.getElementById('tablaTiendas');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                if (!row || !row.tienda) return;
                
                const tr = document.createElement('tr');
                
                // Estilo especial para la fila TODAS
                const esTotalRow = row.tienda === 'TODAS';
                const fontWeight = esTotalRow ? 'font-weight: 800;' : 'font-weight: 600;';
                
                tr.style.borderBottom = '1px solid #E5E7EB';
                if (esTotalRow) {
                    tr.style.background = 'linear-gradient(to right, #F3E8FF, #DBEAFE)';
                }
                
                const desvForecast = getNumericValue(row.desvForecast, 0);
                const crecimientoDia = getNumericValue(row.crecimientoDia, 0);
                const desvForecastAcum = getNumericValue(row.desvForecastAcum, 0);
                const crecimientoAcum = getNumericValue(row.crecimientoAcum, 0);
                
                tr.innerHTML = `
                    <td style="padding: 12px; ${fontWeight} border-right: 2px solid #E5E7EB;">${row.tienda}</td>
                    
                    <!-- COLUMNAS DEL D√çA -->
                    <td style="padding: 12px; text-align: center; color: #6B21A8; font-weight: 700; background: #FEFAFF;">${formatCurrency(row.ventasNetas)}</td>
                    <td style="padding: 12px; text-align: center; background: #FEFAFF;">${formatCurrency(row.forecast)}</td>
                    <td style="padding: 12px; text-align: center; color: ${desvForecast >= 0 ? '#10B981' : '#EF4444'}; font-weight: 600; background: #FEFAFF;">${formatPercentage(desvForecast)}</td>
                    <td style="padding: 12px; text-align: center; color: ${crecimientoDia >= 0 ? '#10B981' : '#EF4444'}; font-weight: 600; background: #FEFAFF; border-right: 2px solid #E5E7EB;">${formatPercentage(crecimientoDia)}</td>
                    
                    <!-- COLUMNAS ACUMULADAS -->
                    <td style="padding: 12px; text-align: center; color: #7C3AED; font-weight: 700; background: #EFF6FF;">${formatCurrency(row.ventasAcumuladas)}</td>
                    <td style="padding: 12px; text-align: center; background: #EFF6FF;">${formatCurrency(row.forecastAcumulado)}</td>
                    <td style="padding: 12px; text-align: center; color: ${desvForecastAcum >= 0 ? '#10B981' : '#EF4444'}; font-weight: 600; background: #EFF6FF;">${formatPercentage(desvForecastAcum)}</td>
                    <td style="padding: 12px; text-align: center; color: ${crecimientoAcum >= 0 ? '#10B981' : '#EF4444'}; font-weight: 600; background: #EFF6FF;">${formatPercentage(crecimientoAcum)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function actualizarTablaDescuentos(totalRow) {
            const tbody = document.getElementById('tablaDescuentos');
            const ordenes = totalRow.ordenesDescuentosAltos || [];
            
            if (ordenes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: #9CA3AF;">No hay √≥rdenes con descuentos ‚â•50%</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            ordenes.forEach(orden => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #E5E7EB';
                
                const porcentaje = getNumericValue(orden.porcentajeDescuento || orden.porcentaje, 0);
                let colorClass = 'color: #F59E0B';
                
                if (porcentaje >= 90) colorClass = 'color: #DC2626; font-weight: 900;';
                else if (porcentaje >= 75) colorClass = 'color: #EF4444; font-weight: 700;';
                else if (porcentaje >= 50) colorClass = 'color: #F97316; font-weight: 600;';
                
                tr.innerHTML = `
                    <td style="padding: 12px;">${orden.tienda}</td>
                    <td style="padding: 12px; text-align: center;">${orden.fecha}</td>
                    <td style="padding: 12px; text-align: center; font-family: monospace; font-size: 12px;">${orden.ordenId}</td>
                    <td style="padding: 12px; text-align: center; color: #F59E0B; font-weight: 700;">${formatCurrency(orden.montoDescuento || orden.descuento)}</td>
                    <td style="padding: 12px; text-align: center; ${colorClass}">${porcentaje.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function actualizarGraficos(totalRow) {
            // Deshabilitar datalabels por defecto para todos los gr√°ficos
            Chart.defaults.set('plugins.datalabels', { display: false });
            
            // Chart Canales
            const ctxCanales = document.getElementById('chartCanales');
            if (charts.canales) charts.canales.destroy();
            
            const dataCanales = [
                getNumericValue(totalRow.uberEats, 0),
                getNumericValue(totalRow.pedidosYa, 0),
                getNumericValue(totalRow.didiFood, 0),
                getNumericValue(totalRow.otrosCanales, 0)
            ];
            
            charts.canales = new Chart(ctxCanales, {
                type: 'doughnut',
                data: {
                    labels: ['Uber Eats', 'Pedidos Ya', 'Didi Food', 'Otros'],
                    datasets: [{
                        data: dataCanales,
                        backgroundColor: ['#10B981', '#EF4444', '#F97316', '#6B7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return percentage > 3 ? percentage + '%' : '';
                            }
                        }
                    }
                }
            });

            // Chart Pagos
            const ctxPagos = document.getElementById('chartPagos');
            if (charts.pagos) charts.pagos.destroy();
            
            const dataPagos = [
                getNumericValue(totalRow.tarjeta, 0),
                getNumericValue(totalRow.efectivo, 0),
                getNumericValue(totalRow.sinpeMovil, 0),
                getNumericValue(totalRow.otrosPagos, 0)
            ];
            
            charts.pagos = new Chart(ctxPagos, {
                type: 'doughnut',
                data: {
                    labels: ['Tarjeta', 'Efectivo', 'Sinpe', 'Otros'],
                    datasets: [{
                        data: dataPagos,
                        backgroundColor: ['#8B5CF6', '#10B981', '#3B82F6', '#6B7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return percentage > 3 ? percentage + '%' : '';
                            }
                        }
                    }
                }
            });
            
            // Chart Detalle M√©todos de Pago (secci√≥n Detalle de Pagos)
            const ctxDetallePagos = document.getElementById('chartDetalleMetodosPago');
            if (ctxDetallePagos) {
                if (charts.detallePagos) charts.detallePagos.destroy();
                
                charts.detallePagos = new Chart(ctxDetallePagos, {
                    type: 'bar',
                    data: {
                        labels: ['Tarjeta', 'Efectivo', 'Sinpe', 'Otros'],
                        datasets: [
                            {
                                label: 'D√≠a',
                                data: [
                                    getNumericValue(totalRow.tarjeta, 0),
                                    getNumericValue(totalRow.efectivo, 0),
                                    getNumericValue(totalRow.sinpeMovil, 0),
                                    getNumericValue(totalRow.otrosPagos, 0)
                                ],
                                backgroundColor: '#8B5CF6'
                            },
                            {
                                label: 'Acumulado',
                                data: [
                                    getNumericValue(totalRow.tarjetaAcum, 0),
                                    getNumericValue(totalRow.efectivoAcum, 0),
                                    getNumericValue(totalRow.sinpeMovilAcum, 0),
                                    getNumericValue(totalRow.otrosPagosAcum, 0)
                                ],
                                backgroundColor: '#10B981'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'top' },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Ç°' + (value/1000).toFixed(0) + 'k';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart Participaci√≥n (secci√≥n Ventas por Semana)
            const ctxParticipacion = document.getElementById('chartParticipacion');
            if (ctxParticipacion && datosGlobales && datosGlobales.length > 1) {
                if (charts.participacion) charts.participacion.destroy();
                
                // Filtrar solo tiendas (excluir "TODAS")
                const tiendas = datosGlobales.filter(d => d.tienda !== 'TODAS');
                const dataParticipacion = tiendas.map(t => getNumericValue(t.ventasAcumuladas, 0));
                
                charts.participacion = new Chart(ctxParticipacion, {
                    type: 'doughnut',
                    data: {
                        labels: tiendas.map(t => t.tienda),
                        datasets: [{
                            data: dataParticipacion,
                            backgroundColor: ['#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#3B82F6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 11 }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                },
                                formatter: (value, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return percentage > 3 ? percentage + '%' : '';
                                }
                            }
                        }
                    }
                });
            }
        }

        // === REPORTE DIARIO ===
        function generarTablaReporteDiario(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.log('No hay datos para el reporte diario');
                return;
            }
            
            // Obtener rango de fechas del filtro
            const fechaInicio = new Date(document.getElementById('fechaInicio').value + 'T00:00:00');
            const fechaFin = new Date(document.getElementById('fechaFin').value + 'T00:00:00');
            
            // Generar array de fechas
            const fechas = [];
            let fechaActual = new Date(fechaInicio);
            
            while (fechaActual <= fechaFin) {
                fechas.push(new Date(fechaActual));
                fechaActual.setDate(fechaActual.getDate() + 1);
            }
            
            // Generar headers de la tabla
            const thead = document.getElementById('headerReporteDiario');
            thead.innerHTML = '<th style="padding: 12px; text-align: left; font-weight: 600; position: sticky; left: 0; background: #F3F4F6; z-index: 10; border-right: 2px solid #D1D5DB;">Local</th>';
            
            fechas.forEach(fecha => {
                const dia = fecha.getDate();
                const mes = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase();
                const a√±o = fecha.getFullYear();
                
                thead.innerHTML += `
                    <th style="padding: 12px; text-align: center; font-weight: 600; background: #F3F4F6; border-right: 1px solid #E5E7EB; min-width: 110px;">
                        <div style="font-size: 10px; color: #6B7280;">${a√±o}</div>
                        <div style="font-size: 13px; font-weight: 700;">${mes}</div>
                        <div style="font-size: 13px;">${String(dia).padStart(2, '0')}</div>
                    </th>
                `;
            });
            
            // Generar filas de tiendas
            const tbody = document.getElementById('bodyReporteDiario');
            tbody.innerHTML = '';
            
            // Filtrar tiendas (excluir TODAS)
            const tiendas = data.filter(d => d.tienda !== 'TODAS');
            const rowTOTAL = data.find(d => d.tienda === 'TODAS');
            
            // Por simplicidad, mostramos el valor del √∫ltimo d√≠a en todas las columnas
            // En una implementaci√≥n real, necesitar√≠as hacer una llamada al backend por cada d√≠a
            tiendas.forEach(tienda => {
                const tr = document.createElement('tr');
                
                // Columna de tienda (fija)
                tr.innerHTML = `<td style="padding: 12px; text-align: left; font-weight: 600; position: sticky; left: 0; background: white; z-index: 5; border-right: 2px solid #D1D5DB;">${tienda.tienda}</td>`;
                
                // Columnas de fechas (mostramos las ventas del d√≠a consultado en la √∫ltima columna)
                fechas.forEach((fecha, index) => {
                    const esUltimoDia = index === fechas.length - 1;
                    const venta = esUltimoDia ? tienda.ventasNetas : 0;
                    
                    tr.innerHTML += `<td style="padding: 10px 12px; text-align: right; border-right: 1px solid #E5E7EB; color: ${venta > 0 ? '#111827' : '#9CA3AF'}; font-weight: ${venta > 0 ? '500' : '400'};">${venta > 0 ? formatCurrency(venta) : '-'}</td>`;
                });
                
                tbody.appendChild(tr);
            });
            
            // Fila TOTAL
            if (rowTOTAL) {
                const trTotal = document.createElement('tr');
                trTotal.style.background = '#EDE9FE';
                trTotal.style.fontWeight = '700';
                
                trTotal.innerHTML = `<td style="padding: 12px; text-align: left; font-weight: 700; position: sticky; left: 0; background: #EDE9FE; z-index: 5; border-right: 2px solid #D1D5DB;">TOTAL</td>`;
                
                fechas.forEach((fecha, index) => {
                    const esUltimoDia = index === fechas.length - 1;
                    const total = esUltimoDia ? rowTOTAL.ventasNetas : 0;
                    
                    trTotal.innerHTML += `<td style="padding: 10px 12px; text-align: right; background: #EDE9FE; font-weight: 700; border-right: 1px solid #E5E7EB;">${total > 0 ? formatCurrency(total) : '-'}</td>`;
                });
                
                tbody.appendChild(trTotal);
            }
        }

        function exportarReporteDiarioExcel() {
            const tabla = document.getElementById('tablaReporteDiario');
            
            if (!tabla || tabla.querySelector('tbody').textContent.includes('Selecciona un rango')) {
                alert('‚ö†Ô∏è No hay datos para exportar. Por favor, carga los datos primero presionando "Actualizar".');
                return;
            }
            
            let csv = '';
            
            // Headers
            const headers = tabla.querySelectorAll('thead th');
            headers.forEach(th => {
                csv += '"' + th.textContent.trim().replace(/\n/g, ' ').replace(/\s+/g, ' ') + '",';
            });
            csv = csv.slice(0, -1) + '\n';
            
            // Rows
            const rows = tabla.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                const cells = tr.querySelectorAll('td');
                cells.forEach(td => {
                    let valor = td.textContent.trim().replace(/‚Ç°/g, '').replace(/,/g, '').replace(/-/g, '0');
                    csv += '"' + valor + '",';
                });
                csv = csv.slice(0, -1) + '\n';
            });
            
            // Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const filename = `Oakberry_ReporteDiario_${fechaInicio}_a_${fechaFin}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Reporte exportado exitosamente como: ' + filename);
        }

        // === INIT ===
        window.addEventListener('load', () => {
            // Set default dates: del 1 del mes actual hasta ayer
            const hoy = new Date();
            const ayer = new Date(hoy);
            ayer.setDate(ayer.getDate() - 1);
            
            // Fecha inicio: primer d√≠a del mes
            const primerDiaMes = new Date(ayer.getFullYear(), ayer.getMonth(), 1);
            
            const yearInicio = primerDiaMes.getFullYear();
            const monthInicio = String(primerDiaMes.getMonth() + 1).padStart(2, '0');
            const dayInicio = String(primerDiaMes.getDate()).padStart(2, '0');
            
            const yearFin = ayer.getFullYear();
            const monthFin = String(ayer.getMonth() + 1).padStart(2, '0');
            const dayFin = String(ayer.getDate()).padStart(2, '0');
            
            document.getElementById('fechaInicio').value = `${yearInicio}-${monthInicio}-${dayInicio}`;
            document.getElementById('fechaFin').value = `${yearFin}-${monthFin}-${dayFin}`;
            
            // Cargar datos autom√°ticamente
            cargarDatos();
        });
        // Variable global para almacenar datos del reporte
let datosReporteDiario = null;

/**
 * Funci√≥n para cargar el reporte diario desde el backend
 */
async function cargarReporteDiario() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        console.log('No hay rango de fechas seleccionado');
        return;
    }
    
    // Obtener tiendas seleccionadas
    const tiendasSeleccionadas = obtenerTiendasSeleccionadas();
    
    const url = `${APPS_SCRIPT_URL}?action=reporteDiario&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&tienda=${tiendasSeleccionadas}`;
    
    console.log('üì° Cargando reporte diario:', url);
    
    try {
        // Mostrar indicador de carga en la tabla
        const tbody = document.getElementById('bodyReporteDiario');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" style="padding: 40px; text-align: center; color: #6B7280;">
                        <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid #E5E7EB; border-top-color: #6B21A8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="margin-top: 10px; font-weight: 600;">Cargando reporte diario...</div>
                        <div style="margin-top: 5px; font-size: 12px; color: #9CA3AF;">Esto puede tardar unos segundos</div>
                    </td>
                </tr>
            `;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        console.log('üìä Reporte diario recibido:', data);
        
        if (data && !data.error && Array.isArray(data) && data.length > 0) {
            datosReporteDiario = data;
            generarTablaReporteDiarioCompleta(data);
        } else {
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="100" style="padding: 40px; text-align: center; color: #EF4444;">
                            ‚ùå ${data.message || 'Error al cargar datos del reporte'}
                        </td>
                    </tr>
                `;
            }
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        const tbody = document.getElementById('bodyReporteDiario');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" style="padding: 40px; text-align: center; color: #EF4444;">
                        ‚ùå Error de conexi√≥n: ${error.message}
                    </td>
                </tr>
            `;
        }
    }
}

/**
 * Genera la tabla del reporte diario con todos los d√≠as
 */
function generarTablaReporteDiarioCompleta(datosReporte) {
    if (!datosReporte || !Array.isArray(datosReporte) || datosReporte.length === 0) {
        console.log('No hay datos para el reporte diario');
        return;
    }
    
    console.log('üìä Generando tabla con', datosReporte.length, 'd√≠as de datos');
    
    // Obtener lista √∫nica de tiendas
    const tiendasSet = new Set();
    datosReporte.forEach(dia => {
        if (dia.tiendas && Array.isArray(dia.tiendas)) {
            dia.tiendas.forEach(t => tiendasSet.add(t.tienda));
        }
    });
    
    const tiendas = Array.from(tiendasSet).sort();
    
    // Generar headers de la tabla
    const thead = document.getElementById('headerReporteDiario');
    if (!thead) {
        console.error('No se encontr√≥ el elemento headerReporteDiario');
        return;
    }
    
    thead.innerHTML = '<th style="padding: 12px; text-align: left; font-weight: 600; position: sticky; left: 0; background: #F3F4F6; z-index: 10; border-right: 2px solid #D1D5DB;">Local</th>';
    
    datosReporte.forEach(dia => {
        const fecha = new Date(dia.fecha + 'T12:00:00');
        const diaNum = fecha.getDate();
        const mes = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase();
        const a√±o = fecha.getFullYear();
        
        thead.innerHTML += `
            <th style="padding: 12px; text-align: center; font-weight: 600; background: #F3F4F6; border-right: 1px solid #E5E7EB; min-width: 100px;">
                <div style="font-size: 10px; color: #6B7280; text-transform: uppercase;">${a√±o}</div>
                <div style="font-size: 13px; font-weight: 700; color: #111827;">${mes}</div>
                <div style="font-size: 13px; color: #374151;">${String(diaNum).padStart(2, '0')}</div>
            </th>
        `;
    });
    
    // Generar cuerpo de la tabla
    const tbody = document.getElementById('bodyReporteDiario');
    if (!tbody) {
        console.error('No se encontr√≥ el elemento bodyReporteDiario');
        return;
    }
    
    tbody.innerHTML = '';
    
    // Objeto para almacenar totales por d√≠a
    const totalesPorDia = {};
    
    // Generar fila por cada tienda
    tiendas.forEach(tienda => {
        const tr = document.createElement('tr');
        
        // Columna de tienda (fija)
        const tdTienda = document.createElement('td');
        tdTienda.style.cssText = 'padding: 12px; text-align: left; font-weight: 600; position: sticky; left: 0; background: white; z-index: 5; border-right: 2px solid #D1D5DB;';
        tdTienda.textContent = tienda;
        tr.appendChild(tdTienda);
        
        // Columnas de ventas por d√≠a
        datosReporte.forEach(dia => {
            const tiendaData = dia.tiendas.find(t => t.tienda === tienda);
            const venta = tiendaData ? (tiendaData.ventasNetas || 0) : 0;
            
            // Acumular para totales
            if (!totalesPorDia[dia.fecha]) {
                totalesPorDia[dia.fecha] = 0;
            }
            totalesPorDia[dia.fecha] += venta;
            
            const td = document.createElement('td');
            td.style.cssText = 'padding: 10px 12px; text-align: right; border-right: 1px solid #E5E7EB;';
            
            if (venta > 0) {
                td.style.color = '#111827';
                td.style.fontWeight = '500';
            }
            
            td.textContent = formatCurrency(venta);
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
    
    // Fila TOTAL
    const trTotal = document.createElement('tr');
    trTotal.style.background = '#EDE9FE';
    trTotal.style.fontWeight = '700';
    
    const tdTotal = document.createElement('td');
    tdTotal.style.cssText = 'padding: 12px; text-align: left; font-weight: 700; position: sticky; left: 0; z-index: 5; border-right: 2px solid #D1D5DB; background: #EDE9FE;';
    tdTotal.textContent = 'TOTAL';
    trTotal.appendChild(tdTotal);
    
    datosReporte.forEach(dia => {
        const td = document.createElement('td');
        td.style.cssText = 'padding: 10px 12px; text-align: right; font-weight: 700; border-right: 1px solid #E5E7EB; background: #EDE9FE;';
        
        const total = totalesPorDia[dia.fecha] || 0;
        td.textContent = formatCurrency(total);
        trTotal.appendChild(td);
    });
    
    tbody.appendChild(trTotal);
    
    console.log('‚úÖ Tabla generada con', tiendas.length, 'tiendas y', datosReporte.length, 'd√≠as');
}

/**
 * Exportar a Excel
 */
function exportarReporteDiarioExcel() {
    if (!datosReporteDiario) {
        alert('No hay datos para exportar. Por favor, carga los datos primero presionando "Actualizar".');
        return;
    }
    
    const tabla = document.getElementById('tablaReporteDiario');
    if (!tabla) {
        alert('Error: No se encontr√≥ la tabla del reporte.');
        return;
    }
    
    let csv = '';
    
    // Headers
    const headers = tabla.querySelectorAll('thead th');
    headers.forEach(th => {
        csv += '"' + th.textContent.trim().replace(/\n/g, ' ').replace(/\s+/g, ' ') + '",';
    });
    csv = csv.slice(0, -1) + '\n';
    
    // Rows
    const rows = tabla.querySelectorAll('tbody tr');
    rows.forEach(tr => {
        const cells = tr.querySelectorAll('td');
        cells.forEach(td => {
            let valor = td.textContent.trim().replace(/‚Ç°/g, '').replace(/,/g, '');
            csv += '"' + valor + '",';
        });
        csv = csv.slice(0, -1) + '\n';
    });
    
    // Descargar
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    const filename = `Oakberry_ReporteDiario_${fechaInicio}_${fechaFin}.csv`;
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('‚úÖ Reporte exportado exitosamente como: ' + filename);
}

// Agregar animaci√≥n de loading al CSS
const styleReporteDiario = document.createElement('style');
styleReporteDiario.textContent = `
    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
if (!document.getElementById('style-reporte-diario')) {
    styleReporteDiario.id = 'style-reporte-diario';
    document.head.appendChild(styleReporteDiario);
}
    </script>
</body>
</html>
