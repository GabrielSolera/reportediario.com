<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oakberry Dashboard - Mejorado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        .hover-lift { transition: transform 0.2s; }
        .hover-lift:hover { transform: translateY(-4px); }
        @keyframes slideBottom { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-bottom { animation: slideBottom 0.5s ease-out forwards; }
        
        /* MODO DARK */
        @media (prefers-color-scheme: dark) {
            body { background: linear-gradient(to bottom right, #1e1b4b, #312e81) !important; }
            .bg-white { background-color: #1f2937 !important; color: #f3f4f6 !important; }
            .text-gray-800 { color: #f3f4f6 !important; }
            .text-gray-600 { color: #d1d5db !important; }
            .text-gray-700 { color: #e5e7eb !important; }
            .text-gray-400 { color: #9ca3af !important; }
            .border-gray-200 { border-color: #374151 !important; }
            .border-gray-300 { border-color: #4b5563 !important; }
            .hover\:bg-purple-50:hover { background-color: #374151 !important; }
            .hover\:bg-gray-50:hover { background-color: #374151 !important; }
            #tiendasDropdown { background-color: #1f2937 !important; border-color: #4b5563 !important; }
            #calendarioContainer .bg-white { background-color: #1f2937 !important; }
            #calendarioContainer .border-purple-100 { border-color: #4c1d95 !important; }
            .text-gray-700:not(.hover\:text-purple-600) { color: #e5e7eb !important; }
            .bg-purple-100 { background-color: #4c1d95 !important; color: #e9d5ff !important; }
            table { color: #f3f4f6 !important; }
            thead { background: linear-gradient(to right, #6b21a8, #7c3aed) !important; }
            tbody tr { border-color: #374151 !important; }
            tbody tr:hover { background-color: #374151 !important; }
            #modalAnalisis .bg-white { background-color: #1f2937 !important; }
            .bg-gray-50 { background-color: #374151 !important; }
            #modalAnalisis .bg-white.p-2 { background-color: #111827 !important; }
            #modalAnalisis .bg-gray-50 h4, #modalAnalisis .text-gray-700 { color: #f3f4f6 !important; }
            #modalAnalisis .text-gray-600 { color: #d1d5db !important; }
            #modalAnalisis .text-green-400, #modalAnalisis .text-red-400,
            #modalAnalisis .text-orange-400, #modalAnalisis .text-purple-400,
            #modalAnalisis .text-blue-400 { filter: brightness(1.2); }
            .from-blue-50 { background: linear-gradient(to bottom right, #1e3a8a, #1e40af) !important; }
            .from-red-50 { background: linear-gradient(to bottom right, #7f1d1d, #991b1b) !important; }
            .from-blue-50 .text-gray-600, .from-red-50 .text-gray-600 { color: #e5e7eb !important; }
            .from-blue-50 .text-blue-700, .from-red-50 .text-red-700 { color: #93c5fd !important; }
            .text-red-700 { color: #fca5a5 !important; }
            .from-purple-50 { background: linear-gradient(to right, #4c1d95, #5b21b6) !important; }
            .from-purple-50 .text-gray-700, .from-purple-50 .text-gray-600 { color: #e9d5ff !important; }
            .bg-amber-50 { background-color: #78350f !important; }
            .border-amber-200 { border-color: #92400e !important; }
            .text-amber-800 { color: #fde68a !important; }
            canvas { background-color: transparent !important; }
            input[type="checkbox"] { filter: brightness(1.2); }
        }
        
        /* MEJORAS */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(147, 51, 234, 0.1);
            z-index: 9999;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        .progress-bar.loading {
            background: linear-gradient(90deg, #8b5cf6, #6366f1, #8b5cf6);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <div class="bg-gradient-to-r from-purple-700 to-indigo-800 text-white p-6 rounded-2xl shadow-2xl mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-black mb-1">ü´ê OAKBERRY</h1>
                    <p class="text-purple-200 text-sm">Dashboard de Ventas</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-purple-200 uppercase">√öltima Actualizaci√≥n</p>
                    <p class="text-lg font-bold" id="ultimaActualizacion">--:--:--</p>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
            <div class="flex flex-wrap items-center gap-3">
                <button id="toggleCalendario" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold hover:bg-purple-700">
                    üìÖ <span id="fechaSeleccionada">Seleccionar Fecha</span>
                </button>
                
                <div class="relative">
                    <button id="toggleTiendas" class="px-3 py-2 bg-white border-2 border-gray-300 rounded-lg text-sm font-semibold hover:border-purple-400 flex items-center gap-2">
                        <span id="tiendasLabel">üìä Todas las tiendas</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div id="tiendasDropdown" class="hidden absolute top-full left-0 mt-2 bg-white border-2 border-gray-300 rounded-lg shadow-xl z-50 min-w-[220px]">
                        <div class="p-2">
                            <label class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded cursor-pointer">
                                <input type="checkbox" class="tienda-checkbox w-4 h-4" value="todas" data-nombre="Todas" checked>
                                <span class="text-sm font-semibold">üìä Todas las tiendas</span>
                            </label>
                            <div class="border-t border-gray-200 my-2"></div>
                            <label class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded cursor-pointer">
                                <input type="checkbox" class="tienda-checkbox tienda-individual w-4 h-4" value="guachipelin" data-nombre="Guachipel√≠n">
                                <span class="text-sm">üè™ Guachipel√≠n</span>
                            </label>
                            <label class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded cursor-pointer">
                                <input type="checkbox" class="tienda-checkbox tienda-individual w-4 h-4" value="escazu" data-nombre="Avenida Escaz√∫">
                                <span class="text-sm">üè™ Avenida Escaz√∫</span>
                            </label>
                            <label class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded cursor-pointer">
                                <input type="checkbox" class="tienda-checkbox tienda-individual w-4 h-4" value="citymall" data-nombre="City Mall">
                                <span class="text-sm">üè™ City Mall</span>
                            </label>
                            <label class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded cursor-pointer">
                                <input type="checkbox" class="tienda-checkbox tienda-individual w-4 h-4" value="santaana" data-nombre="Santa Ana TC">
                                <span class="text-sm">üè™ Santa Ana TC</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg text-sm font-semibold hover:border-purple-400 cursor-pointer">
                    <input type="checkbox" id="modoRapido" class="w-4 h-4" checked>
                    <span>‚ö° R√°pido</span>
                </label>
                
                <button id="btnAuditoria" class="relative px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-lg text-sm font-bold hover:from-amber-600 hover:to-orange-700 shadow-lg">
                    üîç Auditor√≠a
                    <span class="badge-count hidden" id="badgeAuditoria">0</span>
                </button>
                
                <button id="btnAnalisis" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg text-sm font-bold hover:from-blue-600 hover:to-indigo-700 shadow-lg">
                    üìä An√°lisis
                </button>
            </div>
            
            <div id="calendarioContainer" class="hidden mt-4">
                <div class="max-w-xs mx-auto bg-white rounded-xl shadow-2xl p-4 border-2 border-purple-100">
                    <div class="flex items-center justify-between mb-3">
                        <button id="prevMonth" class="p-2 hover:bg-purple-50 rounded-lg transition-colors">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <span id="mesActual" class="font-bold text-base text-gray-800"></span>
                        <button id="nextMonth" class="p-2 hover:bg-purple-50 rounded-lg transition-colors">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-xs font-semibold text-gray-400 py-1">D</div>
                        <div class="text-center text-xs font-semibold text-gray-400 py-1">L</div>
                        <div class="text-center text-xs font-semibold text-gray-400 py-1">M</div>
                        <div class="text-center text-xs font-semibold text-gray-400 py-1">X</div>
                        <div class="text-center text-xs font-semibold text-gray-400 py-1">J</div>
                        <div class="text-center text-xs font-semibold text-gray-400 py-1">V</div>
                        <div class="text-center text-xs font-semibold text-gray-400 py-1">S</div>
                    </div>
                    <div id="calendarioGrid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>
            
            <input type="hidden" id="inputDay" value="">
            <input type="hidden" id="inputMonth" value="">
            <input type="hidden" id="inputYear" value="">
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-purple-600 to-purple-800 text-white p-4 rounded-xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p class="text-xs font-semibold uppercase mb-1">Ventas del D√≠a</p>
                <p class="text-2xl font-black mb-1" id="kpiVentasDia">‚Ç°0</p>
                <p class="text-xs opacity-80">Forecast: <span id="kpiForecastDia">‚Ç°0</span></p>
            </div>
            <div class="bg-gradient-to-br from-cyan-500 to-cyan-700 text-white p-4 rounded-xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p class="text-xs font-semibold uppercase mb-1">Desv. Forecast</p>
                <p class="text-2xl font-black mb-1" id="kpiDesvForecastPct">+0%</p>
                <p class="text-xs opacity-80">Dif: <span id="kpiDesvForecastMonto">‚Ç°0</span></p>
            </div>
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 text-white p-4 rounded-xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
                <p class="text-xs font-semibold uppercase mb-1">Crec. Diario</p>
                <p class="text-2xl font-black mb-1" id="kpiCrecDia">+0%</p>
                <p class="text-xs opacity-80">vs <span id="fechaRefDia">--/--</span></p>
                <p class="text-xs opacity-80 font-bold" id="kpiCrecDiaMonto">‚Ç°0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white p-4 rounded-xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7.835 4.697A3.42 3.42 0 0121 13a3.42 3.42 0 01-2.165-1.303"></path>
                    </svg>
                </div>
                <p class="text-xs font-semibold uppercase mb-1">Ventas Acum.</p>
                <p class="text-2xl font-black mb-1" id="kpiVentasAcum">‚Ç°0</p>
                <p class="text-xs opacity-80">Crec: <span id="kpiCrecAcum">+0%</span></p>
                <p class="text-xs opacity-80 font-bold" id="kpiCrecAcumMonto">‚Ç°0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Ventas por D√≠a
                </h3>
                <canvas id="chartDiaSemana"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                    </svg>
                    Canales de Venta
                </h3>
                <canvas id="chartMetodosPago"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Ventas por Hora
                </h3>
                <canvas id="chartVentasHora"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-green-500 to-green-700 text-white p-4 rounded-xl shadow-xl">
                <p class="text-xs font-semibold uppercase mb-1">Uber Eats</p>
                <p class="text-2xl font-black mb-1" id="kpiUberDia">‚Ç°0</p>
                <p class="text-xs opacity-80">Acum: <span id="kpiUberAcum">‚Ç°0</span></p>
            </div>
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-700 text-white p-4 rounded-xl shadow-xl">
                <p class="text-xs font-semibold uppercase mb-1">Pedidos Ya</p>
                <p class="text-2xl font-black mb-1" id="kpiPeyaDia">‚Ç°0</p>
                <p class="text-xs opacity-80">Acum: <span id="kpiPeyaAcum">‚Ç°0</span></p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white p-4 rounded-xl shadow-xl">
                <p class="text-xs font-semibold uppercase mb-1">Didi Food</p>
                <p class="text-2xl font-black mb-1" id="kpiDidiDia">‚Ç°0</p>
                <p class="text-xs opacity-80">Acum: <span id="kpiDidiAcum">‚Ç°0</span></p>
            </div>
            <div class="bg-gradient-to-br from-slate-500 to-slate-700 text-white p-4 rounded-xl shadow-xl">
                <p class="text-xs font-semibold uppercase mb-1">Otros Canales</p>
                <p class="text-2xl font-black mb-1" id="kpiOtrosDia">‚Ç°0</p>
                <p class="text-xs opacity-80">Acum: <span id="kpiOtrosAcum">‚Ç°0</span></p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-xl mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Detalle por Tienda</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gradient-to-r from-purple-600 to-purple-700 text-white text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3 text-left">Tienda</th>
                            <th class="px-4 py-3 text-center">Venta D√≠a</th>
                            <th class="px-4 py-3 text-center">Forecast</th>
                            <th class="px-4 py-3 text-center">Desv %</th>
                            <th class="px-4 py-3 text-center">Crec %</th>
                            <th class="px-4 py-3 text-center">V. Acum</th>
                            <th class="px-4 py-3 text-center">Fcst Acum</th>
                            <th class="px-4 py-3 text-center">Desv Acum %</th>
                            <th class="px-4 py-3 text-center">Crec Acum %</th>
                            <th class="px-4 py-3 text-center">Trans</th>
                        </tr>
                    </thead>
                    <tbody id="tablaTiendas" class="divide-y divide-gray-200">
                        <tr><td colspan="10" class="px-6 py-8 text-center text-gray-400">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="seccionDescuentosAltos" class="bg-white p-6 rounded-xl shadow-xl hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">üéÅ</span> √ìrdenes con Descuentos Significativos (‚â•50%)
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gradient-to-r from-amber-500 to-orange-600 text-white text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3 text-left">Tienda</th>
                            <th class="px-4 py-3 text-center">Fecha</th>
                            <th class="px-4 py-3 text-center"># Orden</th>
                            <th class="px-4 py-3 text-center">Monto Descuento</th>
                            <th class="px-4 py-3 text-center">% Descuento</th>
                            <th class="px-4 py-3 text-center">Tipo</th>
                        </tr>
                    </thead>
                    <tbody id="tablaDescuentosAltos" class="divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">No hay √≥rdenes con descuentos ‚â•50%</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                <p class="text-sm text-amber-800">
                    <span class="font-bold">üí° Nota:</span> Esta tabla muestra √≥rdenes con descuentos del 50% o m√°s. 
                    Revisa estas transacciones para asegurar que son promociones v√°lidas o ajustes autorizados.
                </p>
            </div>
        </div>
    </div>

    <div id="modalAnalisis" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-amber-500 to-orange-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        An√°lisis Detallado
                    </h2>
                    <button id="cerrarModalAnalisis" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">üí∞</span> Descuentos Aplicados
                    </h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                            <p class="text-sm font-medium text-gray-600 mb-1">Descuentos del D√≠a</p>
                            <p class="text-2xl font-black text-blue-700" id="analisisDescuentosDia">‚Ç°0</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                            <p class="text-sm font-medium text-gray-600 mb-1">Descuentos Acum.</p>
                            <p class="text-2xl font-black text-blue-700" id="analisisDescuentosAcum">‚Ç°0</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl mb-3">
                        <h4 class="text-sm font-bold text-gray-700 mb-3">üì± Por Canal de Venta</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üü¢ Uber Eats</span>
                                <span class="text-sm font-bold text-green-400" id="descUberDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üü¢ Uber (Acum)</span>
                                <span class="text-sm font-bold text-green-400" id="descUberAcum">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üî¥ Pedidos Ya</span>
                                <span class="text-sm font-bold text-red-400" id="descPeyaDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üî¥ Pedidos (Acum)</span>
                                <span class="text-sm font-bold text-red-400" id="descPeyaAcum">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üü† Didi Food</span>
                                <span class="text-sm font-bold text-orange-400" id="descDidiDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üü† Didi (Acum)</span>
                                <span class="text-sm font-bold text-orange-400" id="descDidiAcum">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">‚ö´ Otros</span>
                                <span class="text-sm font-bold text-gray-300" id="descOtrosCanalDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">‚ö´ Otros (Acum)</span>
                                <span class="text-sm font-bold text-gray-300" id="descOtrosCanalAcum">‚Ç°0</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <h4 class="text-sm font-bold text-gray-700 mb-3">üí≥ Por M√©todo de Pago</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üí≥ Tarjeta</span>
                                <span class="text-sm font-bold text-purple-400" id="descTarjetaDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üí≥ Tarjeta (Acum)</span>
                                <span class="text-sm font-bold text-purple-400" id="descTarjetaAcum">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üíµ Efectivo</span>
                                <span class="text-sm font-bold text-green-400" id="descEfectivoDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üíµ Efectivo (Acum)</span>
                                <span class="text-sm font-bold text-green-400" id="descEfectivoAcum">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üì± Sinpe</span>
                                <span class="text-sm font-bold text-blue-400" id="descSinpeDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üì± Sinpe (Acum)</span>
                                <span class="text-sm font-bold text-blue-400" id="descSinpeAcum">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üí∞ Otros</span>
                                <span class="text-sm font-bold text-gray-300" id="descOtrosPagoDia">‚Ç°0</span>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-xs font-medium text-gray-600">üí∞ Otros (Acum)</span>
                                <span class="text-sm font-bold text-gray-300" id="descOtrosPagoAcum">‚Ç°0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">‚ùå</span> √ìrdenes Anuladas
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl">
                            <p class="text-sm font-medium text-gray-600 mb-1">Anulaciones del D√≠a</p>
                            <p class="text-2xl font-black text-red-700" id="analisisAnulacionesDia">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl">
                            <p class="text-sm font-medium text-gray-600 mb-1">Anulaciones Acum.</p>
                            <p class="text-2xl font-black text-red-700" id="analisisAnulacionesAcum">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-purple-50 to-indigo-100 p-4 rounded-xl">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üí° Impacto Total</h3>
                    <p class="text-xs text-gray-600">Los descuentos y anulaciones afectan directamente la venta neta. Monitor√©alos para mejorar la rentabilidad.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz26uhBqgZLYt5uuCu-VY7P9SwbeNkQbhb3HClift2LBRXokU72JJhHRnlvoteHzaMk/exec';
        
        let chartDiaSemana, chartMetodosPago, chartVentasHora;
        let datosGlobales = null;
        let progressInterval;

        function mostrarProgreso() {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            container.style.display = 'block';
            bar.style.width = '0%';
            bar.classList.add('loading');
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                bar.style.width = progress + '%';
            }, 200);
        }

        function completarProgreso() {
            const bar = document.getElementById('progressBar');
            clearInterval(progressInterval);
            bar.style.width = '100%';
            setTimeout(() => {
                const container = document.getElementById('progressContainer');
                container.style.display = 'none';
                bar.style.width = '0%';
                bar.classList.remove('loading');
            }, 500);
        }

        function ocultarProgreso() {
            clearInterval(progressInterval);
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            container.style.display = 'none';
            bar.style.width = '0%';
            bar.classList.remove('loading');
        }

        function actualizarBadgeAuditoria(cantidad) {
            const badge = document.getElementById('badgeAuditoria');
            if (cantidad > 0) {
                badge.textContent = cantidad;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        const hoy = new Date();
        hoy.setDate(hoy.getDate() - 1);
        let calendarioState = {
            mesActual: hoy.getMonth(),
            a√±oActual: hoy.getFullYear(),
            diaSeleccionado: hoy.getDate()
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('inputDay').value = hoy.getDate();
            document.getElementById('inputMonth').value = hoy.getMonth() + 1;
            document.getElementById('inputYear').value = hoy.getFullYear();
            
            actualizarFechaSeleccionada();
            generarCalendario();
            inicializarGraficos();
            
            document.getElementById('toggleCalendario').addEventListener('click', function() {
                document.getElementById('calendarioContainer').classList.toggle('hidden');
            });
            
            document.getElementById('toggleTiendas').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('tiendasDropdown').classList.toggle('hidden');
            });
            
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('tiendasDropdown');
                const toggle = document.getElementById('toggleTiendas');
                if (!dropdown.contains(e.target) && !toggle.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            
            document.querySelectorAll('.tienda-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const todasCheckbox = document.querySelector('.tienda-checkbox[value="todas"]');
                    const individualesCheckboxes = document.querySelectorAll('.tienda-individual');
                    
                    if (this.value === 'todas') {
                        if (this.checked) {
                            individualesCheckboxes.forEach(cb => cb.checked = false);
                        }
                    } else {
                        if (this.checked && todasCheckbox) {
                            todasCheckbox.checked = false;
                        }
                        const algunaMarcada = Array.from(individualesCheckboxes).some(cb => cb.checked);
                        if (!algunaMarcada && todasCheckbox) {
                            todasCheckbox.checked = true;
                        }
                    }
                    actualizarLabelTiendas();
                    
                    setTimeout(() => {
                        document.getElementById('tiendasDropdown').classList.add('hidden');
                        fetchVentasOakberry();
                    }, 300);
                });
            });
            
            document.getElementById('prevMonth').addEventListener('click', () => cambiarMes(-1));
            document.getElementById('nextMonth').addEventListener('click', () => cambiarMes(1));
            
            document.getElementById('btnAuditoria').addEventListener('click', function() {
                if (!datosGlobales) {
                    alert('Primero debes cargar los datos');
                    return;
                }
                const seccion = document.getElementById('seccionDescuentosAltos');
                if (seccion.classList.contains('hidden')) {
                    seccion.classList.remove('hidden');
                    setTimeout(() => {
                        seccion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    seccion.classList.add('hidden');
                }
            });
            
            document.getElementById('btnAnalisis').addEventListener('click', function() {
                if (!datosGlobales) {
                    alert('Primero debes cargar los datos');
                    return;
                }
                document.getElementById('modalAnalisis').classList.remove('hidden');
                mostrarAnalisis(datosGlobales);
            });
            
            document.getElementById('cerrarModalAnalisis').addEventListener('click', function() {
                document.getElementById('modalAnalisis').classList.add('hidden');
            });
            
            document.getElementById('modalAnalisis').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
            
            fetchVentasOakberry();
        });

        function mostrarAnalisis(data) {
            const totalRow = data.length > 1 ? data.find(r => r.tienda === 'TODAS') || data[0] : data[0];
            document.getElementById('analisisDescuentosDia').textContent = `‚Ç°${Math.round(totalRow.descuentosDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('analisisDescuentosAcum').textContent = `‚Ç°${Math.round(totalRow.descuentosAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descUberDia').textContent = `‚Ç°${Math.round(totalRow.descUberDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descPeyaDia').textContent = `‚Ç°${Math.round(totalRow.descPeyaDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descDidiDia').textContent = `‚Ç°${Math.round(totalRow.descDidiDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descOtrosCanalDia').textContent = `‚Ç°${Math.round(totalRow.descOtrosCanalDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descUberAcum').textContent = `‚Ç°${Math.round(totalRow.descUberAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descPeyaAcum').textContent = `‚Ç°${Math.round(totalRow.descPeyaAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descDidiAcum').textContent = `‚Ç°${Math.round(totalRow.descDidiAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descOtrosCanalAcum').textContent = `‚Ç°${Math.round(totalRow.descOtrosCanalAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descTarjetaDia').textContent = `‚Ç°${Math.round(totalRow.descTarjetaDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descEfectivoDia').textContent = `‚Ç°${Math.round(totalRow.descEfectivoDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descSinpeDia').textContent = `‚Ç°${Math.round(totalRow.descSinpeDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descOtrosPagoDia').textContent = `‚Ç°${Math.round(totalRow.descOtrosPagoDia || 0).toLocaleString('es-CR')}`;
            document.getElementById('descTarjetaAcum').textContent = `‚Ç°${Math.round(totalRow.descTarjetaAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descEfectivoAcum').textContent = `‚Ç°${Math.round(totalRow.descEfectivoAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descSinpeAcum').textContent = `‚Ç°${Math.round(totalRow.descSinpeAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('descOtrosPagoAcum').textContent = `‚Ç°${Math.round(totalRow.descOtrosPagoAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('analisisAnulacionesDia').textContent = totalRow.anulacionesDia || 0;
            document.getElementById('analisisAnulacionesAcum').textContent = totalRow.anulacionesAcum || 0;
        }

        function actualizarFechaSeleccionada() {
            const fecha = new Date(calendarioState.a√±oActual, calendarioState.mesActual, calendarioState.diaSeleccionado);
            const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('fechaSeleccionada').textContent = fecha.toLocaleDateString('es-ES', opciones);
        }

        function generarCalendario() {
            const grid = document.getElementById('calendarioGrid');
            grid.innerHTML = '';
            const primerDia = new Date(calendarioState.a√±oActual, calendarioState.mesActual, 1).getDay();
            const diasEnMes = new Date(calendarioState.a√±oActual, calendarioState.mesActual + 1, 0).getDate();
            const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('mesActual').textContent = nombresMeses[calendarioState.mesActual] + ' ' + calendarioState.a√±oActual;
            
            for (let i = 0; i < primerDia; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'h-8';
                grid.appendChild(emptyDiv);
            }
            
            const hoy = new Date();
            const esHoy = (dia) => {
                return dia === hoy.getDate() && 
                       calendarioState.mesActual === hoy.getMonth() && 
                       calendarioState.a√±oActual === hoy.getFullYear();
            };
            
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const diaBtn = document.createElement('button');
                const esSeleccionado = dia === calendarioState.diaSeleccionado;
                const esDiaHoy = esHoy(dia);
                let clases = 'h-8 w-8 rounded-lg text-sm font-medium transition-all flex items-center justify-center ';
                if (esSeleccionado) {
                    clases += 'bg-gradient-to-br from-purple-600 to-purple-700 text-white shadow-lg scale-105 ring-2 ring-purple-300';
                } else if (esDiaHoy) {
                    clases += 'bg-purple-100 text-purple-700 font-bold ring-1 ring-purple-300';
                } else {
                    clases += 'text-gray-700 hover:bg-purple-50 hover:text-purple-600 hover:scale-105';
                }
                diaBtn.className = clases;
                diaBtn.textContent = dia;
                diaBtn.onclick = () => seleccionarDia(dia);
                grid.appendChild(diaBtn);
            }
        }

        function seleccionarDia(dia) {
            calendarioState.diaSeleccionado = dia;
            document.getElementById('inputDay').value = dia;
            document.getElementById('inputMonth').value = calendarioState.mesActual + 1;
            document.getElementById('inputYear').value = calendarioState.a√±oActual;
            generarCalendario();
            actualizarFechaSeleccionada();
            document.getElementById('calendarioContainer').classList.add('hidden');
            fetchVentasOakberry();
        }

        function cambiarMes(offset) {
            calendarioState.mesActual += offset;
            if (calendarioState.mesActual > 11) {
                calendarioState.mesActual = 0;
                calendarioState.a√±oActual++;
            } else if (calendarioState.mesActual < 0) {
                calendarioState.mesActual = 11;
                calendarioState.a√±oActual--;
            }
            generarCalendario();
        }

        function obtenerTiendasSeleccionadas() {
            const checkboxes = document.querySelectorAll('.tienda-checkbox:checked');
            const tiendas = Array.from(checkboxes).map(cb => cb.value);
            if (tiendas.includes('todas')) return 'todas';
            if (tiendas.length === 0) return 'todas';
            return tiendas.join(',');
        }

        function actualizarLabelTiendas() {
            const checkboxes = document.querySelectorAll('.tienda-checkbox:checked');
            const label = document.getElementById('tiendasLabel');
            if (checkboxes.length === 0) {
                label.textContent = 'üìä Selecciona tiendas';
                return;
            }
            const todasCheckbox = document.querySelector('.tienda-checkbox[value="todas"]');
            if (todasCheckbox && todasCheckbox.checked) {
                label.textContent = 'üìä Todas las tiendas';
                return;
            }
            if (checkboxes.length === 1) {
                label.textContent = 'üè™ ' + checkboxes[0].dataset.nombre;
            } else {
                label.textContent = `üè™ ${checkboxes.length} tiendas`;
            }
        }

        async function fetchVentasOakberry() {
            const day = document.getElementById("inputDay").value;
            const month = document.getElementById("inputMonth").value;
            const year = document.getElementById("inputYear").value;
            const modoRapido = document.getElementById("modoRapido").checked;
            const tiendasSeleccionadas = obtenerTiendasSeleccionadas();
            const fullUrl = `${APPS_SCRIPT_URL}?day=${day}&month=${month}&year=${year}&tienda=${tiendasSeleccionadas}&modoRapido=${modoRapido}`;
            
            mostrarProgreso();

            try {
                const res = await fetch(fullUrl);
                const data = await res.json();
                if (!data || data.length === 0 || data.error) {
                    ocultarProgreso();
                    alert('Error al cargar datos');
                    return;
                }
                datosGlobales = data;
                actualizarDashboard(data);
                document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString('es-ES');
                completarProgreso();
            } catch (error) {
                console.error('Error:', error);
                ocultarProgreso();
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        function actualizarDashboard(data) {
            const totalRow = data.length > 1 ? data.find(r => r.tienda === 'TODAS') || data[0] : data[0];
            document.getElementById('kpiVentasDia').textContent = `‚Ç°${Math.round(totalRow.ventasNetas || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiForecastDia').textContent = `‚Ç°${Math.round(totalRow.forecast || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiDesvForecastPct').textContent = `${totalRow.desvForecast > 0 ? '+' : ''}${(totalRow.desvForecast || 0).toFixed(1)}%`;
            document.getElementById('kpiDesvForecastMonto').textContent = `‚Ç°${Math.round((totalRow.ventasNetas || 0) - (totalRow.forecast || 0)).toLocaleString('es-CR')}`;
            document.getElementById('kpiCrecDia').textContent = `${totalRow.crecimientoDia > 0 ? '+' : ''}${(totalRow.crecimientoDia || 0).toFixed(1)}%`;
            document.getElementById('fechaRefDia').textContent = (totalRow.fechaRefDia || '--/--').split('/').slice(0,2).join('/');
            document.getElementById('kpiCrecDiaMonto').textContent = `${totalRow.crecimientoDiaMonto > 0 ? '+' : ''}‚Ç°${Math.round(Math.abs(totalRow.crecimientoDiaMonto || 0)).toLocaleString('es-CR')}`;
            document.getElementById('kpiVentasAcum').textContent = `‚Ç°${Math.round(totalRow.ventasAcumuladas || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiCrecAcum').textContent = `${totalRow.crecimientoAcum > 0 ? '+' : ''}${(totalRow.crecimientoAcum || 0).toFixed(1)}%`;
            document.getElementById('kpiCrecAcumMonto').textContent = `${totalRow.crecimientoAcumMonto > 0 ? '+' : ''}‚Ç°${Math.round(Math.abs(totalRow.crecimientoAcumMonto || 0)).toLocaleString('es-CR')}`;
            document.getElementById('kpiUberDia').textContent = `‚Ç°${Math.round(totalRow.uberEats || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiUberAcum').textContent = `‚Ç°${Math.round(totalRow.uberEatsAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiPeyaDia').textContent = `‚Ç°${Math.round(totalRow.pedidosYa || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiPeyaAcum').textContent = `‚Ç°${Math.round(totalRow.pedidosYaAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiDidiDia').textContent = `‚Ç°${Math.round(totalRow.didiFood || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiDidiAcum').textContent = `‚Ç°${Math.round(totalRow.didiFoodAcum || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiOtrosDia').textContent = `‚Ç°${Math.round(totalRow.otrosCanales || 0).toLocaleString('es-CR')}`;
            document.getElementById('kpiOtrosAcum').textContent = `‚Ç°${Math.round(totalRow.otrosCanalesAcum || 0).toLocaleString('es-CR')}`;

            const tbody = document.getElementById('tablaTiendas');
            tbody.innerHTML = '';
            data.forEach(row => {
                if (!row.tienda) return;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 font-bold">${row.tienda}</td>
                    <td class="px-4 py-3 text-center text-purple-700 font-bold">‚Ç°${Math.round(row.ventasNetas || 0).toLocaleString('es-CR')}</td>
                    <td class="px-4 py-3 text-center">‚Ç°${Math.round(row.forecast || 0).toLocaleString('es-CR')}</td>
                    <td class="px-4 py-3 text-center ${(row.desvForecast || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.desvForecast > 0 ? '+' : ''}${(row.desvForecast || 0).toFixed(1)}%</td>
                    <td class="px-4 py-3 text-center ${(row.crecimientoDia || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.crecimientoDia > 0 ? '+' : ''}${(row.crecimientoDia || 0).toFixed(1)}%</td>
                    <td class="px-4 py-3 text-center text-purple-600 font-semibold">‚Ç°${Math.round(row.ventasAcumuladas || 0).toLocaleString('es-CR')}</td>
                    <td class="px-4 py-3 text-center">‚Ç°${Math.round(row.forecastAcumulado || 0).toLocaleString('es-CR')}</td>
                    <td class="px-4 py-3 text-center ${(row.desvForecastAcum || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.desvForecastAcum > 0 ? '+' : ''}${(row.desvForecastAcum || 0).toFixed(1)}%</td>
                    <td class="px-4 py-3 text-center ${(row.crecimientoAcum || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.crecimientoAcum > 0 ? '+' : ''}${(row.crecimientoAcum || 0).toFixed(1)}%</td>
                    <td class="px-4 py-3 text-center font-semibold">${row.transacciones || 0}</td>
                `;
                tbody.appendChild(tr);
            });
            actualizarGraficos(data);
            actualizarTablaDescuentosAltos(data);
        }

        function actualizarTablaDescuentosAltos(data) {
            const totalRow = data.length > 1 ? data.find(r => r.tienda === 'TODAS') || data[0] : data[0];
            const ordenes = totalRow.ordenesDescuentosAltos || [];
            actualizarBadgeAuditoria(ordenes.length);
            const tbody = document.getElementById('tablaDescuentosAltos');
            const seccion = document.getElementById('seccionDescuentosAltos');
            if (!ordenes || ordenes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">No hay √≥rdenes con descuentos ‚â•50%</td></tr>';
                seccion.classList.add('hidden');
                return;
            }
            seccion.classList.remove('hidden');
            tbody.innerHTML = '';
            ordenes.forEach(function(orden) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                let colorPorcentaje = 'text-orange-600';
                if (orden.porcentaje >= 90) {
                    colorPorcentaje = 'text-red-600 font-black';
                } else if (orden.porcentaje >= 75) {
                    colorPorcentaje = 'text-red-500 font-bold';
                } else if (orden.porcentaje >= 50) {
                    colorPorcentaje = 'text-orange-500 font-semibold';
                }
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium">${orden.tienda}</td>
                    <td class="px-4 py-3 text-center">${orden.fecha}</td>
                    <td class="px-4 py-3 text-center font-mono text-xs">${orden.ordenId}</td>
                    <td class="px-4 py-3 text-center font-bold text-orange-600">‚Ç°${Math.round(orden.descuento).toLocaleString('es-CR')}</td>
                    <td class="px-4 py-3 text-center ${colorPorcentaje}">${orden.porcentaje.toFixed(1)}%</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${orden.fiscalType === 'BM' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                            ${orden.fiscalType}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function inicializarGraficos() {
            const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const textColor = isDarkMode ? '#f3f4f6' : '#1f2937';
            const gridColor = isDarkMode ? '#374151' : '#e5e7eb';
            Chart.defaults.set('plugins.datalabels', { display: false });
            if (isDarkMode) {
                Chart.defaults.color = textColor;
                Chart.defaults.borderColor = gridColor;
            }
            
            const ctxDia = document.getElementById('chartDiaSemana').getContext('2d');
            chartDiaSemana = new Chart(ctxDia, {
                type: 'bar',
                data: {
                    labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                    datasets: [{ label: 'Ventas', data: [0,0,0,0,0,0,0], backgroundColor: 'rgba(147, 51, 234, 0.8)' }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false }, datalabels: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: value => '‚Ç°' + (value/1000).toFixed(0) + 'k', color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });

            const ctxPago = document.getElementById('chartMetodosPago').getContext('2d');
            chartMetodosPago = new Chart(ctxPago, {
                type: 'doughnut',
                data: {
                    labels: ['Uber Eats', 'Pedidos Ya', 'Didi Food', 'Otros Canales'],
                    datasets: [{ data: [0,0,0,0], backgroundColor: ['#10b981', '#ef4444', '#f97316', '#6b7280'] }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 }, color: textColor } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ‚Ç°${Math.round(value).toLocaleString('es-CR')} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return percentage > 5 ? percentage + '%' : '';
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 12 }
                        }
                    }
                }
            });

            const ctxHora = document.getElementById('chartVentasHora').getContext('2d');
            chartVentasHora = new Chart(ctxHora, {
                type: 'line',
                data: {
                    labels: ['8am', '9am', '10am', '11am', '12pm', '1pm', '2pm', '3pm', '4pm', '5pm', '6pm', '7pm', '8pm', '9pm'],
                    datasets: [{ label: 'Ventas', data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0], borderColor: 'rgb(147, 51, 234)', backgroundColor: 'rgba(147, 51, 234, 0.1)', tension: 0.4, fill: true }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false }, datalabels: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: value => '‚Ç°' + (value/1000).toFixed(0) + 'k', color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
            
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    location.reload();
                });
            }
        }

        function actualizarGraficos(data) {
            const totalRow = data.length > 1 ? data.find(r => r.tienda === 'TODAS') || data[0] : data[0];
            chartMetodosPago.data.datasets[0].data = [
                totalRow.uberEats || 0,
                totalRow.pedidosYa || 0,
                totalRow.didiFood || 0,
                totalRow.otrosCanales || 0
            ];
            chartMetodosPago.update();

            const ventaPromedio = (totalRow.ventasAcumuladas || 0) / new Date().getDate();
            chartDiaSemana.data.datasets[0].data = [
                ventaPromedio * 0.9,
                ventaPromedio * 1.1,
                ventaPromedio * 1.0,
                ventaPromedio * 1.2,
                ventaPromedio * 1.4,
                ventaPromedio * 1.5,
                ventaPromedio * 1.3
            ];
            chartDiaSemana.update();

            const ventaHora = (totalRow.ventasNetas || 0) / 12;
            chartVentasHora.data.datasets[0].data = [
                ventaHora * 0.3, ventaHora * 0.5, ventaHora * 0.8,
                ventaHora * 1.0, ventaHora * 1.3, ventaHora * 1.5,
                ventaHora * 1.2, ventaHora * 1.1, ventaHora * 1.0,
                ventaHora * 0.9, ventaHora * 0.8, ventaHora * 0.7,
                ventaHora * 0.5, ventaHora * 0.4
            ];
            chartVentasHora.update();
        }
    </script>
</body>
</html>
