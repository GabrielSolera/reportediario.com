<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Oakberry - Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInFromBottom {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .animate-slide-in {
            animation: slideInFromLeft 0.6s ease-out forwards;
        }
        
        .animate-slide-bottom {
            animation: slideInFromBottom 0.6s ease-out forwards;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(124, 58, 237, 0.3);
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        .card-glow {
            box-shadow: 0 0 30px rgba(124, 58, 237, 0.2);
        }
        
        .number-counter {
            font-variant-numeric: tabular-nums;
        }

        @media (max-width: 768px) {
            .hover-lift:hover {
                transform: translateY(-4px) scale(1.01);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-white to-purple-50 min-h-screen">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-700 via-purple-600 to-purple-800 text-white shadow-2xl overflow-hidden relative">
        <div class="absolute inset-0 shimmer opacity-20"></div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 relative z-10 animate-fade-in">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="animate-slide-in text-center sm:text-left">
                    <div class="flex items-center gap-3">
                        <img src="Logo_Primary_Macaw_Offwhite (2).png" alt="Logo Oakberry" class="h-10 sm:h-12">
                        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-black tracking-tight mb-2">OAKBERRY</h1>
                    </div>
                    <p class="text-purple-200 text-base sm:text-lg lg:text-xl font-light">Dashboard de Ventas</p>
                </div>
                <div class="flex items-center gap-3 sm:gap-4 animate-slide-in" style="animation-delay: 0.2s; opacity: 0;">
                    <div class="bg-white/20 backdrop-blur-lg px-4 sm:px-6 py-2 sm:py-3 rounded-xl border border-white/30 hover:bg-white/30 transition-all duration-300">
                        <p class="text-xs text-purple-200 font-semibold uppercase tracking-wide">Última actualización</p>
                        <p class="text-base sm:text-lg font-bold" id="lastUpdate">Cargando...</p>
                    </div>
                    <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse shadow-lg shadow-green-400/50"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- Filtros Ultra Compactos -->
        <div class="bg-white p-3 rounded-lg shadow-md mb-4 border border-gray-200">
            <div class="flex flex-wrap items-center gap-2">
                <!-- Botón Calendario -->
                <button id="toggleCalendario" class="px-2 py-1 bg-purple-600 text-white rounded text-xs font-semibold hover:bg-purple-700 transition-colors">
                    📅
                </button>
                
                <!-- Tienda -->
                <select id="inputTienda" class="px-2 py-1 text-xs rounded border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
                    <option value="todas">📊 Todas</option>
                    <option value="guachipelin">Guachipelín</option>
                </select>
                
                <!-- Modo -->
                <select id="inputModoVista" class="px-2 py-1 text-xs rounded border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
                    <option value="analisis">📈 Análisis</option>
                    <option value="comparativo">⚖️ Comparativo</option>
                </select>
                
                <!-- Botón Filtrar -->
                <button id="btnFiltrar" class="px-3 py-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded text-xs font-bold hover:scale-105 transition-transform">
                    Filtrar
                </button>
                
                <!-- Botón Reset -->
                <button id="btnReset" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-semibold hover:border-red-400 hover:text-red-600 transition-colors">
                    🔄
                </button>
                
                <!-- Indicador -->
                <span class="ml-auto text-xs text-gray-500 font-semibold">
                    <span class="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    En vivo
                </span>
            </div>
            
            <!-- Calendario Mini Colapsable -->
            <div id="calendarioContainer" class="mt-3 hidden">
                <div class="bg-gray-50 rounded-lg p-2 border border-gray-200">
                    <!-- Header del Calendario -->
                    <div class="flex items-center justify-between mb-2">
                        <button id="prevMonth" class="p-1 hover:bg-gray-200 rounded transition-colors">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div class="text-center">
                            <p class="text-xs font-bold text-gray-800" id="mesActual">Octubre 2025</p>
                            <p class="text-xs text-purple-600 font-semibold" id="fechaSeleccionada">3 de Octubre</p>
                        </div>
                        <button id="nextMonth" class="p-1 hover:bg-gray-200 rounded transition-colors">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Días de la semana -->
                    <div class="grid grid-cols-7 gap-1 mb-1">
                        <div class="text-center text-xs font-semibold text-gray-400">D</div>
                        <div class="text-center text-xs font-semibold text-gray-400">L</div>
                        <div class="text-center text-xs font-semibold text-gray-400">M</div>
                        <div class="text-center text-xs font-semibold text-gray-400">X</div>
                        <div class="text-center text-xs font-semibold text-gray-400">J</div>
                        <div class="text-center text-xs font-semibold text-gray-400">V</div>
                        <div class="text-center text-xs font-semibold text-gray-400">S</div>
                    </div>
                    
                    <!-- Grid de días -->
                    <div id="calendarioGrid" class="grid grid-cols-7 gap-1 mb-2">
                        <!-- Generado dinámicamente -->
                    </div>
                    
                    <!-- Botones rápidos -->
                    <div class="flex gap-1">
                        <button class="quick-date-btn flex-1 px-2 py-1 bg-white hover:bg-purple-100 rounded text-xs font-semibold border border-gray-200 transition-colors" data-offset="0">Hoy</button>
                        <button class="quick-date-btn flex-1 px-2 py-1 bg-white hover:bg-purple-100 rounded text-xs font-semibold border border-gray-200 transition-colors" data-offset="-1">Ayer</button>
                        <button class="quick-date-btn flex-1 px-2 py-1 bg-white hover:bg-purple-100 rounded text-xs font-semibold border border-gray-200 transition-colors" data-offset="-7">-7d</button>
                    </div>
                </div>
            </div>
            
            <!-- Hidden inputs -->
            <input type="hidden" id="inputDay" value="3">
            <input type="hidden" id="inputMonth" value="10">
            <input type="hidden" id="inputYear" value="2025">
        </div>

        <!-- KPIs Principales - 6 tarjetas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <!-- Ventas del Día -->
            <div class="bg-gradient-to-br from-purple-600 to-purple-800 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.2s; opacity: 0;">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-white/20 rounded-xl backdrop-blur">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-black" id="badgeVentasDia">105.4%</div>
                </div>
                <p class="text-purple-200 text-xs font-semibold uppercase tracking-wider mb-2">Ventas del Día</p>
                <p class="text-4xl font-black mb-3 number-counter" id="kpiVentasDia">₡0</p>
                <div class="flex items-center justify-between pt-3 border-t border-white/20">
                    <span class="text-xs text-purple-200">Forecast: <span id="kpiForecastDia">₡0</span></span>
                    <div class="flex items-center gap-1 bg-white/20 px-2 py-1 rounded-lg">
                        <span class="text-xs font-bold" id="kpiDesvDia">0%</span>
                    </div>
                </div>
            </div>

            <!-- Desviación vs Forecast -->
            <div class="bg-gradient-to-br from-cyan-500 to-cyan-700 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.3s; opacity: 0;">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-white/20 rounded-xl backdrop-blur">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-black" id="badgeDesvForecast">SOBRE FORECAST</div>
                </div>
                <p class="text-cyan-100 text-xs font-semibold uppercase tracking-wider mb-2">Desviación vs Forecast</p>
                <p class="text-4xl font-black mb-3 number-counter" id="kpiDesvForecastPct">+0%</p>
                <div class="pt-3 border-t border-white/20">
                    <p class="text-xs text-cyan-100">Diferencia: <span class="font-bold" id="kpiDesvForecastMonto">₡0</span></p>
                </div>
            </div>

            <!-- Crecimiento Diario -->
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.4s; opacity: 0;">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-white/20 rounded-xl backdrop-blur">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
                <p class="text-emerald-100 text-xs font-semibold uppercase tracking-wider mb-2">Crecimiento Diario</p>
                <p class="text-4xl font-black mb-3 number-counter" id="kpiCrecDia">+0%</p>
                <div class="pt-3 border-t border-white/20">
                    <p class="text-xs text-emerald-100">vs <span class="font-bold" id="fechaRefDia">--/--/----</span></p>
                </div>
            </div>

            <!-- Ventas Acumuladas -->
            <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.5s; opacity: 0;">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-white/20 rounded-xl backdrop-blur">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                    </div>
                    <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-black">MES</div>
                </div>
                <p class="text-purple-200 text-xs font-semibold uppercase tracking-wider mb-2">Ventas Acumuladas</p>
                <p class="text-4xl font-black mb-3 number-counter" id="kpiVentasAcum">₡0</p>
                <div class="pt-3 border-t border-white/20">
                    <p class="text-xs text-purple-200">Forecast: <span class="font-bold" id="kpiForecastAcum">₡0</span></p>
                </div>
            </div>

            <!-- Desviación Forecast Acum -->
            <div class="bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.6s; opacity: 0;">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-white/20 rounded-xl backdrop-blur">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-black" id="badgeDesvAcum">SOBRE OBJETIVO</div>
                </div>
                <p class="text-amber-100 text-xs font-semibold uppercase tracking-wider mb-2">Desv. Forecast Acum.</p>
                <p class="text-4xl font-black mb-3 number-counter" id="kpiDesvForecastAcumPct">+0%</p>
                <div class="pt-3 border-t border-white/20">
                    <p class="text-xs text-amber-100">Diferencia: <span class="font-bold" id="kpiDesvForecastAcumMonto">₡0</span></p>
                </div>
            </div>

            <!-- Crecimiento Acumulado -->
            <div class="bg-gradient-to-br from-indigo-500 to-indigo-700 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.7s; opacity: 0;">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-white/20 rounded-xl backdrop-blur">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-black">MTD</div>
                </div>
                <p class="text-indigo-100 text-xs font-semibold uppercase tracking-wider mb-2">Crec. Acumulado</p>
                <p class="text-4xl font-black mb-3 number-counter" id="kpiCrecAcum">+0%</p>
                <div class="pt-3 border-t border-white/20">
                    <p class="text-xs text-indigo-100">vs <span class="font-bold" id="periodoRefAcum">Mes anterior</span></p>
                </div>
            </div>
        </div>

        <!-- Nuevas tarjetas de Delivery -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <!-- Uber Eats -->
            <div class="relative bg-gradient-to-br from-green-500 to-green-700 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.8s; opacity: 0;">
                <div class="flex items-center justify-between mb-3">
                    <img src="ubereats.webp" alt="Uber Eats" class="h-10 w-auto">
                </div>
                <p class="text-green-100 text-xs font-semibold uppercase tracking-wider mb-2">Uber Eats</p>
                <p class="text-3xl font-black mb-2 number-counter" id="kpiUberDia">₡0</p>
                <p class="text-xs text-green-100">Acumulado: <span class="font-bold" id="kpiUberAcum">₡0</span></p>
            </div>

            <!-- Pedidos Ya -->
            <div class="relative bg-gradient-to-br from-red-500 to-red-700 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 0.9s; opacity: 0;">
                <div class="flex items-center justify-between mb-3">
                    <img src="pedidosya.png" alt="Pedidos Ya" class="h-10 w-auto">
                </div>
                <p class="text-red-100 text-xs font-semibold uppercase tracking-wider mb-2">Pedidos Ya</p>
                <p class="text-3xl font-black mb-2 number-counter" id="kpiPeyaDia">₡0</p>
                <p class="text-xs text-red-100">Acumulado: <span class="font-bold" id="kpiPeyaAcum">₡0</span></p>
            </div>

            <!-- Didi Food -->
            <div class="relative bg-gradient-to-br from-orange-500 to-orange-700 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 1.0s; opacity: 0;">
                <div class="flex items-center justify-between mb-3">
                    <img src="didi.png" alt="Didi Food" class="h-10 w-auto">
                </div>
                <p class="text-orange-100 text-xs font-semibold uppercase tracking-wider mb-2">Didi Food</p>
                <p class="text-3xl font-black mb-2 number-counter" id="kpiDidiDia">₡0</p>
                <p class="text-xs text-orange-100">Acumulado: <span class="font-bold" id="kpiDidiAcum">₡0</span></p>
            </div>

            <!-- Otros Pagos -->
            <div class="bg-gradient-to-br from-slate-500 to-slate-700 text-white p-6 rounded-2xl shadow-2xl hover-lift animate-slide-bottom" style="animation-delay: 1.1s; opacity: 0;">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-2 bg-white/20 rounded-xl backdrop-blur">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                </div>
                <p class="text-slate-100 text-xs font-semibold uppercase tracking-wider mb-2">Otros Pagos</p>
                <p class="text-3xl font-black mb-2 number-counter" id="kpiOtrosDia">₡0</p>
                <p class="text-xs text-slate-100">Acumulado: <span class="font-bold" id="kpiOtrosAcum">₡0</span></p>
            </div>
        </div>

        <!-- Tabla Detallada -->
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-purple-100 animate-slide-bottom" style="animation-delay: 1.2s; opacity: 0;">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                </svg>
                Detalle Ventas Diarias & Acumuladas
            </h3>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gradient-to-r from-purple-600 to-purple-700 text-white text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3 text-left">Tienda</th>
                            <th class="px-4 py-3 text-center">Venta Día</th>
                            <th class="px-4 py-3 text-center">Forecast Día</th>
                            <th class="px-4 py-3 text-center">Desv. Forecast</th>
                            <th class="px-4 py-3 text-center">Crec. % Día</th>
                            <th class="px-4 py-3 text-center">Ventas Acum.</th>
                            <th class="px-4 py-3 text-center">Forecast Acum.</th>
                            <th class="px-4 py-3 text-center">Desv. Forecast Acum.</th>
                            <th class="px-4 py-3 text-center">Crec. Acum.</th>
                            <th class="px-4 py-3 text-center">Transacciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaTiendas" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="10" class="px-6 py-8 text-center text-gray-400">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ⚠️ URL ACTUALIZADA DEL WEB APP DE APPS SCRIPT
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz26uhBqgZLYt5uuCu-VY7P9SwbeNkQbhb3HClift2LBRXokU72JJhHRnlvoteHzaMk/exec';

        async function fetchVentasOakberry() {
            const day = document.getElementById("inputDay").value;
            const month = document.getElementById("inputMonth").value; // Cambiado: usar .value directamente
            const year = document.getElementById("inputYear").value;
            const tienda = document.getElementById("inputTienda").value;
            const modoVista = document.getElementById("inputModoVista").value;

            console.log('🔍 ========== INICIO FETCH ==========');
            console.log('📅 Parámetros:', { day, month, year, tienda, modoVista });
            console.log('🔗 URL Base:', APPS_SCRIPT_URL);
            
            const fullUrl = `${APPS_SCRIPT_URL}?day=${day}&month=${month}&year=${year}&tienda=${tienda}&modoVista=${modoVista}`;
            console.log('🌐 URL Completa:', fullUrl);

            try {
                console.log('📡 Haciendo fetch...');
                const res = await fetch(fullUrl);
                
                console.log('📦 Response status:', res.status);
                console.log('📦 Response OK:', res.ok);
                console.log('📦 Content-Type:', res.headers.get('content-type'));
                
                const textResponse = await res.text();
                console.log('📄 Response (primeros 500 chars):', textResponse.substring(0, 500));
                
                let data;
                try {
                    data = JSON.parse(textResponse);
                    console.log('✅ JSON parseado correctamente');
                    console.log('📊 Data:', data);
                } catch (parseError) {
                    console.error('❌ Error parseando JSON:', parseError);
                    console.error('📄 Respuesta completa:', textResponse);
                    alert('Error: La respuesta no es JSON válido. Revisa la consola (F12)');
                    return;
                }

                if (!data || data.length === 0 || data.error) {
                    console.error('❌ Error en los datos:', data);
                    alert('Error al cargar datos. Revisa la consola (F12)');
                    return;
                }

                const totalRow = data.find(row => row.tienda === "Oakberry Guachipelin" || row.tienda === "Total") || data[0];
                
                console.log('✅ Datos encontrados:', totalRow);
                console.log('💰 Ventas Netas:', totalRow.ventasNetas);
                console.log('📊 Transacciones:', totalRow.transacciones);
                
                // Actualizar KPIs principales
                document.getElementById('kpiVentasDia').textContent = `₡${Math.round(totalRow.ventasNetas).toLocaleString('es-CR')}`;
                document.getElementById('kpiForecastDia').textContent = `₡${Math.round(totalRow.forecast || 0).toLocaleString('es-CR')}`;
                document.getElementById('kpiDesvDia').textContent = `${totalRow.desvForecast > 0 ? '+' : ''}${(totalRow.desvForecast || 0).toFixed(1)}%`;
                
                document.getElementById('kpiDesvForecastPct').textContent = `${totalRow.desvForecast > 0 ? '+' : ''}${(totalRow.desvForecast || 0).toFixed(1)}%`;
                document.getElementById('kpiDesvForecastMonto').textContent = `₡${Math.round((totalRow.ventasNetas || 0) - (totalRow.forecast || 0)).toLocaleString('es-CR')}`;
                
                document.getElementById('kpiCrecDia').textContent = `${totalRow.crecimientoDia > 0 ? '+' : ''}${(totalRow.crecimientoDia || 0).toFixed(1)}%`;
                document.getElementById('fechaRefDia').textContent = totalRow.fechaRefDia || '--/--/----';
                
                document.getElementById('kpiVentasAcum').textContent = `₡${Math.round(totalRow.ventasAcumuladas || 0).toLocaleString('es-CR')}`;
                document.getElementById('kpiForecastAcum').textContent = `₡${Math.round(totalRow.forecastAcumulado || 0).toLocaleString('es-CR')}`;
                
                document.getElementById('kpiDesvForecastAcumPct').textContent = `${totalRow.desvForecastAcum > 0 ? '+' : ''}${(totalRow.desvForecastAcum || 0).toFixed(1)}%`;
                document.getElementById('kpiDesvForecastAcumMonto').textContent = `₡${Math.round((totalRow.ventasAcumuladas || 0) - (totalRow.forecastAcumulado || 0)).toLocaleString('es-CR')}`;
                
                document.getElementById('kpiCrecAcum').textContent = `${totalRow.crecimientoAcum > 0 ? '+' : ''}${(totalRow.crecimientoAcum || 0).toFixed(1)}%`;
                document.getElementById('periodoRefAcum').textContent = totalRow.periodoRefAcum || 'Mes anterior';

                // Actualizar KPIs de delivery
                document.getElementById('kpiUberDia').textContent = `₡${Math.round(totalRow.uber || 0).toLocaleString('es-CR')}`;
                document.getElementById('kpiUberAcum').textContent = `₡${Math.round(totalRow.uberAcum || 0).toLocaleString('es-CR')}`;
                
                document.getElementById('kpiPeyaDia').textContent = `₡${Math.round(totalRow.peya || 0).toLocaleString('es-CR')}`;
                document.getElementById('kpiPeyaAcum').textContent = `₡${Math.round(totalRow.peyaAcum || 0).toLocaleString('es-CR')}`;
                
                document.getElementById('kpiDidiDia').textContent = `₡${Math.round(totalRow.didi || 0).toLocaleString('es-CR')}`;
                document.getElementById('kpiDidiAcum').textContent = `₡${Math.round(totalRow.didiAcum || 0).toLocaleString('es-CR')}`;
                
                document.getElementById('kpiOtrosDia').textContent = `₡${Math.round(totalRow.otros || 0).toLocaleString('es-CR')}`;
                document.getElementById('kpiOtrosAcum').textContent = `₡${Math.round(totalRow.otrosAcum || 0).toLocaleString('es-CR')}`;

                // Actualizar badges
                const pctVsForec = totalRow.forecast > 0 ? ((totalRow.ventasNetas / totalRow.forecast) * 100).toFixed(1) : '0.0';
                document.getElementById('badgeVentasDia').textContent = `${pctVsForec}%`;
                document.getElementById('badgeDesvForecast').textContent = (totalRow.desvForecast || 0) >= 0 ? 'SOBRE FORECAST' : 'BAJO FORECAST';
                document.getElementById('badgeDesvAcum').textContent = (totalRow.desvForecastAcum || 0) >= 0 ? 'SOBRE OBJETIVO' : 'BAJO OBJETIVO';

                // Actualizar tabla
                const tbody = document.getElementById('tablaTiendas');
                tbody.innerHTML = '';
                
                data.forEach(row => {
                    if (!row.tienda) return;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 transition';
                    tr.innerHTML = `
                        <td class="px-4 py-3 font-bold text-gray-900">${row.tienda}</td>
                        <td class="px-4 py-3 text-center text-purple-700 font-bold">₡${Math.round(row.ventasNetas || 0).toLocaleString('es-CR')}</td>
                        <td class="px-4 py-3 text-center">₡${Math.round(row.forecast || 0).toLocaleString('es-CR')}</td>
                        <td class="px-4 py-3 text-center ${(row.desvForecast || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.desvForecast > 0 ? '+' : ''}${(row.desvForecast || 0).toFixed(1)}%</td>
                        <td class="px-4 py-3 text-center ${(row.crecimientoDia || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.crecimientoDia > 0 ? '+' : ''}${(row.crecimientoDia || 0).toFixed(1)}%</td>
                        <td class="px-4 py-3 text-center">₡${Math.round(row.ventasAcumuladas || 0).toLocaleString('es-CR')}</td>
                        <td class="px-4 py-3 text-center">₡${Math.round(row.forecastAcumulado || 0).toLocaleString('es-CR')}</td>
                        <td class="px-4 py-3 text-center ${(row.desvForecastAcum || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.desvForecastAcum > 0 ? '+' : ''}${(row.desvForecastAcum || 0).toFixed(1)}%</td>
                        <td class="px-4 py-3 text-center ${(row.crecimientoAcum || 0) >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${row.crecimientoAcum > 0 ? '+' : ''}${(row.crecimientoAcum || 0).toFixed(1)}%</td>
                        <td class="px-4 py-3 text-center font-semibold">${row.transacciones || 0}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error('❌ ========== ERROR CATCH ==========');
                console.error('Tipo de error:', error.name);
                console.error('Mensaje:', error.message);
                console.error('Stack:', error.stack);
                console.error('Error completo:', error);
                
                alert('❌ Error de conexión.\n\n' +
                      'Detalles: ' + error.message + '\n\n' +
                      'Abre la consola (F12) para más información.');
            }
            
            console.log('🏁 ========== FIN FETCH ==========');
        }

        // ============================================
        // CALENDARIO COMPACTO
        // ============================================

        // ================================
        // FUNCIONES DE FECHA EQUIVALENTE MES ANTERIOR
        // ================================
        /**
         * Devuelve la fecha equivalente al mismo día de la semana del mes anterior.
         * @param {Date} fechaActual
         * @returns {Date}
         */
        function getFechaEquivalenteMesAnterior(fechaActual) {
            const nuevaFecha = new Date(fechaActual);
            const diaSemana = nuevaFecha.getDay(); // 0 = domingo ... 6 = sábado
            const diasTranscurridos = nuevaFecha.getDate() - diaSemana;

            nuevaFecha.setMonth(nuevaFecha.getMonth() - 1);
            nuevaFecha.setDate(1); // Inicio del mes anterior

            let fechaEquivalente = new Date(nuevaFecha);
            fechaEquivalente.setDate(fechaEquivalente.getDate() + diasTranscurridos);

            return fechaEquivalente;
        }
        
        let calendarioState = {
            mesActual: 9,
            añoActual: 2025,
            diaSeleccionado: 3
        };
        
        const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        function generarCalendario() {
            const grid = document.getElementById('calendarioGrid');
            grid.innerHTML = '';
            
            const primerDia = new Date(calendarioState.añoActual, calendarioState.mesActual, 1).getDay();
            const diasEnMes = new Date(calendarioState.añoActual, calendarioState.mesActual + 1, 0).getDate();
            
            for (let i = 0; i < primerDia; i++) {
                grid.appendChild(document.createElement('div'));
            }
            
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const diaBtn = document.createElement('button');
                diaBtn.className = `h-7 rounded text-xs font-semibold transition-all ${
                    dia === calendarioState.diaSeleccionado
                        ? 'bg-purple-600 text-white scale-110'
                        : 'bg-gray-100 text-gray-700 hover:bg-purple-100 hover:scale-105'
                }`;
                diaBtn.textContent = dia;
                diaBtn.onclick = () => seleccionarDia(dia);
                grid.appendChild(diaBtn);
            }
            
            document.getElementById('mesActual').textContent = nombresMeses[calendarioState.mesActual] + ' ' + calendarioState.añoActual;
            actualizarFechaSeleccionada();
        }
        
        function seleccionarDia(dia) {
            calendarioState.diaSeleccionado = dia;
            document.getElementById('inputDay').value = dia;
            document.getElementById('inputMonth').value = calendarioState.mesActual + 1;
            document.getElementById('inputYear').value = calendarioState.añoActual;
            generarCalendario();
        }
        
        function actualizarFechaSeleccionada() {
            const fecha = new Date(calendarioState.añoActual, calendarioState.mesActual, calendarioState.diaSeleccionado);
            const opciones = { day: 'numeric', month: 'long' };
            document.getElementById('fechaSeleccionada').textContent = fecha.toLocaleDateString('es-ES', opciones);
        }
        
        function cambiarMes(offset) {
            calendarioState.mesActual += offset;
            if (calendarioState.mesActual > 11) {
                calendarioState.mesActual = 0;
                calendarioState.añoActual++;
            } else if (calendarioState.mesActual < 0) {
                calendarioState.mesActual = 11;
                calendarioState.añoActual--;
            }
            generarCalendario();
        }
        
        function seleccionarFechaRapida(offset) {
            const hoy = new Date();
            hoy.setDate(hoy.getDate() + offset);
            calendarioState.diaSeleccionado = hoy.getDate();
            calendarioState.mesActual = hoy.getMonth();
            calendarioState.añoActual = hoy.getFullYear();
            document.getElementById('inputDay').value = calendarioState.diaSeleccionado;
            document.getElementById('inputMonth').value = calendarioState.mesActual + 1;
            document.getElementById('inputYear').value = calendarioState.añoActual;
            generarCalendario();
        }

        // ============================================
        // EJEMPLO DE USO DE getFechaEquivalenteMesAnterior EN OTRA FUNCIÓN
        // ============================================
        // function procesarVentasToteat(fechaActual) {
        //     // ... otras líneas ...
        //     // var fechaMesAnterior = new Date(year, month - 2, day);
        //     // if (fechaMesAnterior.getMonth() < 0) {
        //     //   fechaMesAnterior.setFullYear(year - 1);
        //     //   fechaMesAnterior.setMonth(11); // diciembre año anterior
        //     // }
        //     var fechaMesAnterior = getFechaEquivalenteMesAnterior(fechaActual);
        //     // ... resto del código ...
        // }

        document.addEventListener("DOMContentLoaded", () => {
            // Generar calendario
            generarCalendario();
            
            // Toggle calendario
            document.getElementById('toggleCalendario').addEventListener('click', function() {
                const cal = document.getElementById('calendarioContainer');
                cal.classList.toggle('hidden');
                this.textContent = cal.classList.contains('hidden') ? '📅' : '❌';
            });
            
            // Navegación
            document.getElementById('prevMonth').addEventListener('click', () => cambiarMes(-1));
            document.getElementById('nextMonth').addEventListener('click', () => cambiarMes(1));
            
            // Fechas rápidas
            document.querySelectorAll('.quick-date-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    seleccionarFechaRapida(parseInt(this.getAttribute('data-offset')));
                });
            });
            
            // Cargar datos iniciales
            fetchVentasOakberry();
            
            // Configurar botón de filtrar
            document.getElementById("btnFiltrar").addEventListener("click", function() {
                // Animación del botón
                this.classList.add('scale-95');
                setTimeout(() => {
                    this.classList.remove('scale-95');
                }, 200);
                
                // Mostrar loading
                mostrarLoading();
                
                // Cargar datos
                fetchVentasOakberry();
            });
            
            // Actualizar indicador de modo de vista
            document.getElementById("inputModoVista").addEventListener("change", function() {
                const modos = {
                    'analisis': '📈 Modo: Análisis',
                    'comparativo': '⚖️ Modo: Comparativo',
                    'tendencias': '📊 Modo: Tendencias'
                };
                document.getElementById("modoVistaTexto").textContent = modos[this.value] || 'Modo: Análisis';
            });
            
            // Enter key en inputs para filtrar
            ['inputDay', 'inputMonth', 'inputYear'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById("btnFiltrar").click();
                    }
                });
            });
        });

        function mostrarLoading() {
            // Agregar efecto de loading a las tarjetas
            const tarjetas = document.querySelectorAll('.hover-lift');
            tarjetas.forEach(tarjeta => {
                tarjeta.style.opacity = '0.5';
            });
            
            setTimeout(() => {
                tarjetas.forEach(tarjeta => {
                    tarjeta.style.opacity = '1';
                });
            }, 500);
        }

        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const timeElement = document.getElementById('lastUpdate');
            if (timeElement) {
                timeElement.textContent = `${hours}:${minutes}:${seconds}`;
            }
        }
        
        updateTime();
        setInterval(updateTime, 1000);

        window.addEventListener('load', function() {
            const elements = document.querySelectorAll('.animate-slide-in, .animate-slide-bottom, .animate-fade-in');
            elements.forEach((el, index) => {
                setTimeout(() => {
                    el.style.opacity = '1';
                }, index * 100);
            });
        });
    </script>
</body>
</html>
